SET documentdb.next_collection_id TO 8000;
SET documentdb.next_collection_index_id TO 8000;
SET documentdb_core.enableCollation TO on;
SET documentdb.enableCollationWithIndexes TO on;
SET documentdb.defaultUseCompositeOpClass TO off;
SET search_path TO documentdb_api,documentdb_core,documentdb_api_catalog;
CREATE SCHEMA collation_index_test_schema;
CREATE FUNCTION collation_index_test_schema.gin_bson_index_term_to_bson(bytea) 
RETURNS bson
LANGUAGE c
AS '$libdir/pg_documentdb', 'gin_bson_index_term_to_bson';
-- ===== Single-path indexes ======
SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'coll_idx_db',
  '{
    "createIndexes": "coll_collated",
    "indexes": [{
      "key": { "name": 1 },
      "name": "name_collated_idx",
      "collation": { "locale": "en", "strength": 1 }
    }]
  }',
  TRUE
);
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT (index_spec).index_name,
       documentdb_core.bson_get_value_text((index_spec).index_options, 'collation') AS collation
FROM documentdb_api_catalog.collection_indexes
WHERE collection_id = (SELECT collection_id FROM documentdb_api_catalog.collections 
                       WHERE database_name = 'coll_idx_db' AND collection_name = 'coll_collated')
ORDER BY index_id;
    index_name     |              collation              
-------------------+-------------------------------------
 _id_              | 
 name_collated_idx | { "locale" : "en", "strength" : 1 }
(2 rows)

-- Check the index structure after insertions
SELECT documentdb_api.insert_one('coll_idx_db', 'coll_collated', '{"_id": 1, "name": "Apple"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_collated', '{"_id": 2, "name": "apple"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_collated', '{"_id": 3, "name": "APPLE"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_collated', '{"_id": 4, "name": "Banana"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_collated', '{"_id": 5, "name": "banana"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_collated', '{"_id": 6, "name": "cherry"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

\d documentdb_data.documents_8001
          Table "documentdb_data.documents_8001"
     Column      |  Type  | Collation | Nullable | Default 
-----------------+--------+-----------+----------+---------
 shard_key_value | bigint |           | not null | 
 object_id       | bson   |           | not null | 
 document        | bson   |           | not null | 
Indexes:
    "collection_pk_8001" PRIMARY KEY, btree (shard_key_value, object_id)
    "documents_rum_index_8002" documentdb_extended_rum (document documentdb_extended_rum_catalog.bson_extended_rum_single_path_ops (path=name, tl='2699', "collation"='en-u-ks-level1'))
Check constraints:
    "shard_key_value_check" CHECK (shard_key_value = '8001'::bigint)

-- Strength=1: 6 docs produce 4 index entries (Apple/apple/APPLE collapsed, Banana/banana collapsed)
SELECT entry->>'offset' AS offset,
       collation_index_test_schema.gin_bson_index_term_to_bson((entry->>'firstEntry')::bytea) AS index_term
FROM documentdb_api_internal.documentdb_rum_page_get_entries(
    public.get_raw_page('documentdb_data.documents_rum_index_8002', 1), 
    'documentdb_data.documents_rum_index_8002'::regclass
) entry;
 offset |                      index_term                       
--------+-------------------------------------------------------
 1      | { "" : true, "$flags" : { "$numberInt" : "2" } }
 2      | { "$" : "Apple", "$flags" : { "$numberInt" : "0" } }
 3      | { "$" : "Banana", "$flags" : { "$numberInt" : "0" } }
 4      | { "$" : "cherry", "$flags" : { "$numberInt" : "0" } }
(4 rows)

-- TODO: Query with matching collation should use the index
-- It will not use the index yet until we have supported index pushdown.
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('coll_idx_db', '{ "find": "coll_collated", "filter": { "name": { "$eq": "apple" } }, "collation": { "locale": "en", "strength": 1 } }');
                       document                       
------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "name" : "Apple" }
 { "_id" : { "$numberInt" : "2" }, "name" : "apple" }
 { "_id" : { "$numberInt" : "3" }, "name" : "APPLE" }
(3 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('coll_idx_db', '{ "find": "coll_collated", "filter": { "name": { "$eq": "apple" } }, "collation": { "locale": "en", "strength": 1 } }');
                                           QUERY PLAN                                            
-------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documentdb_data.documents_8001 collection
   Output: document
   Recheck Cond: (collection.shard_key_value = '8001'::bigint)
   Filter: (collection.document @= '{ "name" : "apple", "collation" : "en-u-ks-level1" }'::bson)
   ->  Bitmap Index Scan on _id_
         Index Cond: (collection.shard_key_value = '8001'::bigint)
(6 rows)

ROLLBACK;
-- numericOrdering: true 
SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'coll_idx_db',
  '{
    "createIndexes": "coll_numeric_true",
    "indexes": [{
      "key": { "item": 1 },
      "name": "item_numorder_true_idx",
      "collation": { "locale": "en", "numericOrdering": true }
    }]
  }',
  TRUE
);
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_numeric_true', '{"_id": 1, "item": "item1"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_numeric_true', '{"_id": 2, "item": "item10"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_numeric_true', '{"_id": 3, "item": "item2"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_numeric_true', '{"_id": 4, "item": "item20"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_numeric_true', '{"_id": 5, "item": "item3"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

\d documentdb_data.documents_8002
          Table "documentdb_data.documents_8002"
     Column      |  Type  | Collation | Nullable | Default 
-----------------+--------+-----------+----------+---------
 shard_key_value | bigint |           | not null | 
 object_id       | bson   |           | not null | 
 document        | bson   |           | not null | 
Indexes:
    "collection_pk_8002" PRIMARY KEY, btree (shard_key_value, object_id)
    "documents_rum_index_8004" documentdb_extended_rum (document documentdb_extended_rum_catalog.bson_extended_rum_single_path_ops (path=item, tl='2699', "collation"='en-u-ks-level3-kn-true'))
Check constraints:
    "shard_key_value_check" CHECK (shard_key_value = '8002'::bigint)

-- numericOrdering=true: sorted numerically as item1 < item2 < item3 < item10 < item20
SELECT entry->>'offset' AS offset,
       collation_index_test_schema.gin_bson_index_term_to_bson((entry->>'firstEntry')::bytea) AS index_term
FROM documentdb_api_internal.documentdb_rum_page_get_entries(
    public.get_raw_page('documentdb_data.documents_rum_index_8004', 1), 
    'documentdb_data.documents_rum_index_8004'::regclass
) entry;
 offset |                      index_term                       
--------+-------------------------------------------------------
 1      | { "" : true, "$flags" : { "$numberInt" : "2" } }
 2      | { "$" : "item1", "$flags" : { "$numberInt" : "0" } }
 3      | { "$" : "item2", "$flags" : { "$numberInt" : "0" } }
 4      | { "$" : "item3", "$flags" : { "$numberInt" : "0" } }
 5      | { "$" : "item10", "$flags" : { "$numberInt" : "0" } }
 6      | { "$" : "item20", "$flags" : { "$numberInt" : "0" } }
(6 rows)

-- numericOrdering: false 
SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'coll_idx_db',
  '{
    "createIndexes": "coll_numeric_false",
    "indexes": [{
      "key": { "item": 1 },
      "name": "item_numorder_false_idx",
      "collation": { "locale": "en", "numericOrdering": false }
    }]
  }',
  TRUE
);
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_numeric_false', '{"_id": 1, "item": "item1"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_numeric_false', '{"_id": 2, "item": "item10"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_numeric_false', '{"_id": 3, "item": "item2"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_numeric_false', '{"_id": 4, "item": "item20"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_numeric_false', '{"_id": 5, "item": "item3"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

\d documentdb_data.documents_8003
          Table "documentdb_data.documents_8003"
     Column      |  Type  | Collation | Nullable | Default 
-----------------+--------+-----------+----------+---------
 shard_key_value | bigint |           | not null | 
 object_id       | bson   |           | not null | 
 document        | bson   |           | not null | 
Indexes:
    "collection_pk_8003" PRIMARY KEY, btree (shard_key_value, object_id)
    "documents_rum_index_8006" documentdb_extended_rum (document documentdb_extended_rum_catalog.bson_extended_rum_single_path_ops (path=item, tl='2699', "collation"='en-u-ks-level3'))
Check constraints:
    "shard_key_value_check" CHECK (shard_key_value = '8003'::bigint)

-- numericOrdering=false: sorted lexically as item1 < item10 < item2 < item20 < item3
SELECT entry->>'offset' AS offset,
       collation_index_test_schema.gin_bson_index_term_to_bson((entry->>'firstEntry')::bytea) AS index_term
FROM documentdb_api_internal.documentdb_rum_page_get_entries(
    public.get_raw_page('documentdb_data.documents_rum_index_8006', 1), 
    'documentdb_data.documents_rum_index_8006'::regclass
) entry;
 offset |                      index_term                       
--------+-------------------------------------------------------
 1      | { "" : true, "$flags" : { "$numberInt" : "2" } }
 2      | { "$" : "item1", "$flags" : { "$numberInt" : "0" } }
 3      | { "$" : "item10", "$flags" : { "$numberInt" : "0" } }
 4      | { "$" : "item2", "$flags" : { "$numberInt" : "0" } }
 5      | { "$" : "item20", "$flags" : { "$numberInt" : "0" } }
 6      | { "$" : "item3", "$flags" : { "$numberInt" : "0" } }
(6 rows)

-- ===== Single-path index with arrays and nested objects ======
SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'coll_idx_db',
  '{
    "createIndexes": "coll_nested",
    "indexes": [{
      "key": { "tags": 1 },
      "name": "tags_collated_idx",
      "collation": { "locale": "en", "strength": 1 }
    }]
  }',
  TRUE
);
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Insert documents with arrays containing strings
SELECT documentdb_api.insert_one('coll_idx_db', 'coll_nested', '{"_id": 1, "tags": ["Apple", "Banana"]}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_nested', '{"_id": 2, "tags": ["apple", "cherry"]}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_nested', '{"_id": 3, "tags": ["APPLE", "BANANA", "zebra"]}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_nested', '{"_id": 4, "tags": "single_tag"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Nested object with string value at indexed path
SELECT documentdb_api.insert_one('coll_idx_db', 'coll_nested', '{"_id": 5, "tags": {"nested": "value"}}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

\d documentdb_data.documents_8004
          Table "documentdb_data.documents_8004"
     Column      |  Type  | Collation | Nullable | Default 
-----------------+--------+-----------+----------+---------
 shard_key_value | bigint |           | not null | 
 object_id       | bson   |           | not null | 
 document        | bson   |           | not null | 
Indexes:
    "collection_pk_8004" PRIMARY KEY, btree (shard_key_value, object_id)
    "documents_rum_index_8008" documentdb_extended_rum (document documentdb_extended_rum_catalog.bson_extended_rum_single_path_ops (path=tags, tl='2699', "collation"='en-u-ks-level1'))
Check constraints:
    "shard_key_value_check" CHECK (shard_key_value = '8004'::bigint)

-- Strength=1 arrays: 10 entries - case variants (Apple/apple/APPLE) share one sort key
SELECT entry->>'offset' AS offset,
       collation_index_test_schema.gin_bson_index_term_to_bson((entry->>'firstEntry')::bytea) AS index_term
FROM documentdb_api_internal.documentdb_rum_page_get_entries(
    public.get_raw_page('documentdb_data.documents_rum_index_8008', 1), 
    'documentdb_data.documents_rum_index_8008'::regclass
) entry;
 offset |                                 index_term                                  
--------+-----------------------------------------------------------------------------
 1      | { "" : true, "$flags" : { "$numberInt" : "2" } }
 2      | { "$" : "Apple", "$flags" : { "$numberInt" : "0" } }
 3      | { "$" : "Banana", "$flags" : { "$numberInt" : "0" } }
 4      | { "$" : "cherry", "$flags" : { "$numberInt" : "0" } }
 5      | { "$" : "single_tag", "$flags" : { "$numberInt" : "0" } }
 6      | { "$" : "zebra", "$flags" : { "$numberInt" : "0" } }
 7      | { "$" : { "nested" : "value" }, "$flags" : { "$numberInt" : "0" } }
 8      | { "$" : [ "Apple", "Banana" ], "$flags" : { "$numberInt" : "0" } }
 9      | { "$" : [ "APPLE", "BANANA", "zebra" ], "$flags" : { "$numberInt" : "0" } }
 10     | { "$" : [ "apple", "cherry" ], "$flags" : { "$numberInt" : "0" } }
(10 rows)

-- ===== Single-path index with arrays/nested objects: strength=3 (case-sensitive) ======
SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'coll_idx_db',
  '{
    "createIndexes": "coll_nested_s3",
    "indexes": [{
      "key": { "tags": 1 },
      "name": "tags_collated_s3_idx",
      "collation": { "locale": "en", "strength": 3 }
    }]
  }',
  TRUE
);
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Insert same documents as strength=1 test for comparison
SELECT documentdb_api.insert_one('coll_idx_db', 'coll_nested_s3', '{"_id": 1, "tags": ["Apple", "Banana"]}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_nested_s3', '{"_id": 2, "tags": ["apple", "cherry"]}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_nested_s3', '{"_id": 3, "tags": ["APPLE", "BANANA", "zebra"]}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_nested_s3', '{"_id": 4, "tags": "single_tag"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_nested_s3', '{"_id": 5, "tags": {"nested": "value"}}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

\d documentdb_data.documents_8005
          Table "documentdb_data.documents_8005"
     Column      |  Type  | Collation | Nullable | Default 
-----------------+--------+-----------+----------+---------
 shard_key_value | bigint |           | not null | 
 object_id       | bson   |           | not null | 
 document        | bson   |           | not null | 
Indexes:
    "collection_pk_8005" PRIMARY KEY, btree (shard_key_value, object_id)
    "documents_rum_index_8010" documentdb_extended_rum (document documentdb_extended_rum_catalog.bson_extended_rum_single_path_ops (path=tags, tl='2699', "collation"='en-u-ks-level3'))
Check constraints:
    "shard_key_value_check" CHECK (shard_key_value = '8005'::bigint)

-- Strength=3 arrays: 13 entries - case variants (apple, Apple, APPLE) each get separate sort keys
SELECT entry->>'offset' AS offset,
       collation_index_test_schema.gin_bson_index_term_to_bson((entry->>'firstEntry')::bytea) AS index_term
FROM documentdb_api_internal.documentdb_rum_page_get_entries(
    public.get_raw_page('documentdb_data.documents_rum_index_8010', 1), 
    'documentdb_data.documents_rum_index_8010'::regclass
) entry;
 offset |                                 index_term                                  
--------+-----------------------------------------------------------------------------
 1      | { "" : true, "$flags" : { "$numberInt" : "2" } }
 2      | { "$" : "apple", "$flags" : { "$numberInt" : "0" } }
 3      | { "$" : "Apple", "$flags" : { "$numberInt" : "0" } }
 4      | { "$" : "APPLE", "$flags" : { "$numberInt" : "0" } }
 5      | { "$" : "Banana", "$flags" : { "$numberInt" : "0" } }
 6      | { "$" : "BANANA", "$flags" : { "$numberInt" : "0" } }
 7      | { "$" : "cherry", "$flags" : { "$numberInt" : "0" } }
 8      | { "$" : "single_tag", "$flags" : { "$numberInt" : "0" } }
 9      | { "$" : "zebra", "$flags" : { "$numberInt" : "0" } }
 10     | { "$" : { "nested" : "value" }, "$flags" : { "$numberInt" : "0" } }
 11     | { "$" : [ "apple", "cherry" ], "$flags" : { "$numberInt" : "0" } }
 12     | { "$" : [ "Apple", "Banana" ], "$flags" : { "$numberInt" : "0" } }
 13     | { "$" : [ "APPLE", "BANANA", "zebra" ], "$flags" : { "$numberInt" : "0" } }
(13 rows)

-- ===== Wildcard index with collation ======
SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'coll_idx_db',
  '{
    "createIndexes": "coll_wildcard_coll",
    "indexes": [{
      "key": { "$**": 1 },
      "name": "wildcard_collated_idx",
      "collation": { "locale": "en", "strength": 2 }
    }]
  }',
  TRUE
);
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT (index_spec).index_name,
       documentdb_core.bson_get_value_text((index_spec).index_options, 'collation') AS collation
FROM documentdb_api_catalog.collection_indexes
WHERE collection_id = (SELECT collection_id FROM documentdb_api_catalog.collections 
                       WHERE database_name = 'coll_idx_db' AND collection_name = 'coll_wildcard_coll')
ORDER BY index_id;
      index_name       |              collation              
-----------------------+-------------------------------------
 _id_                  | 
 wildcard_collated_idx | { "locale" : "en", "strength" : 2 }
(2 rows)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_wildcard_coll', '{"_id": 1, "name": "Zebra", "city": "Austin"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_wildcard_coll', '{"_id": 2, "name": "apple", "city": "Boston"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_wildcard_coll', '{"_id": 3, "name": "Apple", "city": "Chicago"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_wildcard_coll', '{"_id": 4, "name": "banana", "city": "Denver"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

\d documentdb_data.documents_8006
          Table "documentdb_data.documents_8006"
     Column      |  Type  | Collation | Nullable | Default 
-----------------+--------+-----------+----------+---------
 shard_key_value | bigint |           | not null | 
 object_id       | bson   |           | not null | 
 document        | bson   |           | not null | 
Indexes:
    "collection_pk_8006" PRIMARY KEY, btree (shard_key_value, object_id)
    "documents_rum_index_8012" documentdb_extended_rum (document documentdb_extended_rum_catalog.bson_extended_rum_single_path_ops (path='', iswildcard='true', tl='2699', wkl='200', "collation"='en-u-ks-level2'))
Check constraints:
    "shard_key_value_check" CHECK (shard_key_value = '8006'::bigint)

-- Strength=2 wildcard: indexes all fields; name sorted as apple < banana < Zebra
SELECT entry->>'offset' AS offset,
       collation_index_test_schema.gin_bson_index_term_to_bson((entry->>'firstEntry')::bytea) AS index_term
FROM documentdb_api_internal.documentdb_rum_page_get_entries(
    public.get_raw_page('documentdb_data.documents_rum_index_8012', 1), 
    'documentdb_data.documents_rum_index_8012'::regclass
) entry;
 offset |                              index_term                               
--------+-----------------------------------------------------------------------
 1      | { "" : true, "$flags" : { "$numberInt" : "2" } }
 2      | { "_id" : { "$numberInt" : "1" }, "$flags" : { "$numberInt" : "0" } }
 3      | { "_id" : { "$numberInt" : "2" }, "$flags" : { "$numberInt" : "0" } }
 4      | { "_id" : { "$numberInt" : "3" }, "$flags" : { "$numberInt" : "0" } }
 5      | { "_id" : { "$numberInt" : "4" }, "$flags" : { "$numberInt" : "0" } }
 6      | { "city" : "Austin", "$flags" : { "$numberInt" : "0" } }
 7      | { "city" : "Boston", "$flags" : { "$numberInt" : "0" } }
 8      | { "city" : "Chicago", "$flags" : { "$numberInt" : "0" } }
 9      | { "city" : "Denver", "$flags" : { "$numberInt" : "0" } }
 10     | { "name" : "apple", "$flags" : { "$numberInt" : "0" } }
 11     | { "name" : "banana", "$flags" : { "$numberInt" : "0" } }
 12     | { "name" : "Zebra", "$flags" : { "$numberInt" : "0" } }
(12 rows)

-- ===== Wildcard projection index ======
SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'coll_idx_db',
  '{
    "createIndexes": "coll_wp_coll",
    "indexes": [{
      "key": { "$**": 1 },
      "name": "wp_collated_idx",
      "wildcardProjection": { "title": 1 },
      "collation": { "locale": "en", "strength": 1 }
    }]
  }',
  TRUE
);
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT (index_spec).index_name,
       documentdb_core.bson_get_value_text((index_spec).index_options, 'collation') AS collation
FROM documentdb_api_catalog.collection_indexes
WHERE collection_id = (SELECT collection_id FROM documentdb_api_catalog.collections 
                       WHERE database_name = 'coll_idx_db' AND collection_name = 'coll_wp_coll')
ORDER BY index_id;
   index_name    |              collation              
-----------------+-------------------------------------
 _id_            | 
 wp_collated_idx | { "locale" : "en", "strength" : 1 }
(2 rows)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_wp_coll', '{"_id": 1, "title": "Zebra", "other": "not_indexed"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_wp_coll', '{"_id": 2, "title": "apple", "other": "not_indexed"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_wp_coll', '{"_id": 3, "title": "APPLE", "other": "not_indexed"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_wp_coll', '{"_id": 4, "title": "banana", "other": "not_indexed"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

\d documentdb_data.documents_8007
          Table "documentdb_data.documents_8007"
     Column      |  Type  | Collation | Nullable | Default 
-----------------+--------+-----------+----------+---------
 shard_key_value | bigint |           | not null | 
 object_id       | bson   |           | not null | 
 document        | bson   |           | not null | 
Indexes:
    "collection_pk_8007" PRIMARY KEY, btree (shard_key_value, object_id)
    "documents_rum_index_8014" documentdb_rum (document bson_rum_wildcard_project_path_ops (includeid='false', tl='2699', wkl='200', "collation"='en-u-ks-level1', pathspec='[ "title" ]', isexclusion='false'))
Check constraints:
    "shard_key_value_check" CHECK (shard_key_value = '8007'::bigint)

-- Strength=1 wildcard projection: only "title" field indexed; apple/APPLE collapsed
SELECT entry->>'offset' AS offset,
       collation_index_test_schema.gin_bson_index_term_to_bson((entry->>'firstEntry')::bytea) AS index_term
FROM documentdb_api_internal.documentdb_rum_page_get_entries(
    public.get_raw_page('documentdb_data.documents_rum_index_8014', 1), 
    'documentdb_data.documents_rum_index_8014'::regclass
) entry;
 offset |                        index_term                         
--------+-----------------------------------------------------------
 1      | { "" : true, "$flags" : { "$numberInt" : "2" } }
 2      | { "title" : "apple", "$flags" : { "$numberInt" : "0" } }
 3      | { "title" : "banana", "$flags" : { "$numberInt" : "0" } }
 4      | { "title" : "Zebra", "$flags" : { "$numberInt" : "0" } }
(4 rows)

-- ===== Truncated long strings with collation ======
SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'coll_idx_db',
  '{
    "createIndexes": "coll_truncated",
    "indexes": [{
      "key": { "longfield": 1 },
      "name": "longfield_collated_idx",
      "collation": { "locale": "en", "strength": 1 }
    }]
  }',
  TRUE
);
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Insert documents with very long strings that will be truncated
-- Different prefixes to test ordering: "aaa..." vs "bbb..." vs "zzz..."
SELECT documentdb_api.insert_one('coll_idx_db', 'coll_truncated', 
  bson_build_document('_id'::text, 1, 'longfield'::text, ('aaa' || repeat('x', 3000))::text), NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_truncated', 
  bson_build_document('_id'::text, 2, 'longfield'::text, ('AAA' || repeat('x', 3000))::text), NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_truncated', 
  bson_build_document('_id'::text, 3, 'longfield'::text, ('bbb' || repeat('y', 3000))::text), NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_truncated', 
  bson_build_document('_id'::text, 4, 'longfield'::text, ('BBB' || repeat('y', 3000))::text), NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_truncated', 
  bson_build_document('_id'::text, 5, 'longfield'::text, ('zzz' || repeat('z', 3000))::text), NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_truncated', 
  bson_build_document('_id'::text, 6, 'longfield'::text, ('ZZZ' || repeat('z', 3000))::text), NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

\d documentdb_data.documents_8008
          Table "documentdb_data.documents_8008"
     Column      |  Type  | Collation | Nullable | Default 
-----------------+--------+-----------+----------+---------
 shard_key_value | bigint |           | not null | 
 object_id       | bson   |           | not null | 
 document        | bson   |           | not null | 
Indexes:
    "collection_pk_8008" PRIMARY KEY, btree (shard_key_value, object_id)
    "documents_rum_index_8016" documentdb_extended_rum (document documentdb_extended_rum_catalog.bson_extended_rum_single_path_ops (path=longfield, tl='2699', "collation"='en-u-ks-level1'))
Check constraints:
    "shard_key_value_check" CHECK (shard_key_value = '8008'::bigint)

-- Strength=1 truncated: 5 entries for 6 docs - aaa.../AAA... and bbb.../BBB... collapsed; $flags=1 indicates truncation
SELECT entry->>'offset' AS offset,
       collation_index_test_schema.gin_bson_index_term_to_bson((entry->>'firstEntry')::bytea) AS index_term
FROM documentdb_api_internal.documentdb_rum_page_get_entries(
    public.get_raw_page('documentdb_data.documents_rum_index_8016', 1), 
    'documentdb_data.documents_rum_index_8016'::regclass
) entry;
 offset |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  index_term                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
--------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1      | { "" : true, "$flags" : { "$numberInt" : "2" } }
 2      | { "" : { "$maxKey" : 1 }, "$flags" : { "$numberInt" : "1" } }
 3      | { "$" : "aaaxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx", "$flags" : { "$numberInt" : "1" } }
 4      | { "$" : "bbbyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy", "$flags" : { "$numberInt" : "1" } }
 5      | { "$" : "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz", "$flags" : { "$numberInt" : "1" } }
(5 rows)

-- ===== Truncated strings with strength=3 (case-sensitive) ======
SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'coll_idx_db',
  '{
    "createIndexes": "coll_truncated_s3",
    "indexes": [{
      "key": { "longfield": 1 },
      "name": "longfield_collated_s3_idx",
      "collation": { "locale": "en", "strength": 3 }
    }]
  }',
  TRUE
);
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Same long strings with case-sensitive collation
SELECT documentdb_api.insert_one('coll_idx_db', 'coll_truncated_s3', 
  bson_build_document('_id'::text, 1, 'longfield'::text, ('aaa' || repeat('x', 3000))::text), NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_truncated_s3', 
  bson_build_document('_id'::text, 2, 'longfield'::text, ('AAA' || repeat('x', 3000))::text), NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_truncated_s3', 
  bson_build_document('_id'::text, 3, 'longfield'::text, ('bbb' || repeat('y', 3000))::text), NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_truncated_s3', 
  bson_build_document('_id'::text, 4, 'longfield'::text, ('BBB' || repeat('y', 3000))::text), NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_truncated_s3', 
  bson_build_document('_id'::text, 5, 'longfield'::text, ('zzz' || repeat('z', 3000))::text), NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_truncated_s3', 
  bson_build_document('_id'::text, 6, 'longfield'::text, ('ZZZ' || repeat('z', 3000))::text), NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

\d documentdb_data.documents_8009
          Table "documentdb_data.documents_8009"
     Column      |  Type  | Collation | Nullable | Default 
-----------------+--------+-----------+----------+---------
 shard_key_value | bigint |           | not null | 
 object_id       | bson   |           | not null | 
 document        | bson   |           | not null | 
Indexes:
    "collection_pk_8009" PRIMARY KEY, btree (shard_key_value, object_id)
    "documents_rum_index_8018" documentdb_extended_rum (document documentdb_extended_rum_catalog.bson_extended_rum_single_path_ops (path=longfield, tl='2699', "collation"='en-u-ks-level3'))
Check constraints:
    "shard_key_value_check" CHECK (shard_key_value = '8009'::bigint)

-- Strength=3 truncated: 8 entries for 6 docs - aaa.../AAA..., bbb.../BBB..., zzz.../ZZZ... each distinct; $flags=1 indicates truncation
SELECT entry->>'offset' AS offset,
       collation_index_test_schema.gin_bson_index_term_to_bson((entry->>'firstEntry')::bytea) AS index_term
FROM documentdb_api_internal.documentdb_rum_page_get_entries(
    public.get_raw_page('documentdb_data.documents_rum_index_8018', 1), 
    'documentdb_data.documents_rum_index_8018'::regclass
) entry;
 offset |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  index_term                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
--------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1      | { "" : true, "$flags" : { "$numberInt" : "2" } }
 2      | { "" : { "$maxKey" : 1 }, "$flags" : { "$numberInt" : "1" } }
 3      | { "$" : "aaaxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx", "$flags" : { "$numberInt" : "1" } }
 4      | { "$" : "AAAxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx", "$flags" : { "$numberInt" : "1" } }
 5      | { "$" : "bbbyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy", "$flags" : { "$numberInt" : "1" } }
 6      | { "$" : "BBByyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy", "$flags" : { "$numberInt" : "1" } }
 7      | { "$" : "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz", "$flags" : { "$numberInt" : "1" } }
 8      | { "$" : "ZZZzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz", "$flags" : { "$numberInt" : "1" } }
(8 rows)

-- ===== Mix of truncated and non-truncated strings ======
SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'coll_idx_db',
  '{
    "createIndexes": "coll_mixed_length",
    "indexes": [{
      "key": { "data": 1 },
      "name": "data_collated_idx",
      "collation": { "locale": "en", "strength": 1 }
    }]
  }',
  TRUE
);
NOTICE:  creating collection
                                                                                                   create_indexes_non_concurrently                                                                                                   
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : true, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- Short strings (no truncation)
SELECT documentdb_api.insert_one('coll_idx_db', 'coll_mixed_length', '{"_id": 1, "data": "Apple"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_mixed_length', '{"_id": 2, "data": "apple"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Medium strings with same prefix as truncated ones
SELECT documentdb_api.insert_one('coll_idx_db', 'coll_mixed_length', 
  bson_build_document('_id'::text, 3, 'data'::text, ('apple' || repeat('z', 50))::text), NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Long truncated strings
SELECT documentdb_api.insert_one('coll_idx_db', 'coll_mixed_length', 
  bson_build_document('_id'::text, 4, 'data'::text, ('apple' || repeat('z', 3000))::text), NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_mixed_length', 
  bson_build_document('_id'::text, 5, 'data'::text, ('APPLE' || repeat('z', 3000))::text), NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Another short string that should sort after apple
SELECT documentdb_api.insert_one('coll_idx_db', 'coll_mixed_length', '{"_id": 6, "data": "banana"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

\d documentdb_data.documents_8010
          Table "documentdb_data.documents_8010"
     Column      |  Type  | Collation | Nullable | Default 
-----------------+--------+-----------+----------+---------
 shard_key_value | bigint |           | not null | 
 object_id       | bson   |           | not null | 
 document        | bson   |           | not null | 
Indexes:
    "collection_pk_8010" PRIMARY KEY, btree (shard_key_value, object_id)
    "documents_rum_index_8020" documentdb_extended_rum (document documentdb_extended_rum_catalog.bson_extended_rum_single_path_ops (path=data, tl='2699', "collation"='en-u-ks-level1'))
Check constraints:
    "shard_key_value_check" CHECK (shard_key_value = '8010'::bigint)

-- Strength=1 mixed lengths: short "Apple"/"apple" collapsed; truncated entries have $flags=1
SELECT entry->>'offset' AS offset,
       collation_index_test_schema.gin_bson_index_term_to_bson((entry->>'firstEntry')::bytea) AS index_term
FROM documentdb_api_internal.documentdb_rum_page_get_entries(
    public.get_raw_page('documentdb_data.documents_rum_index_8020', 1), 
    'documentdb_data.documents_rum_index_8020'::regclass
) entry;
 offset |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  index_term                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
--------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1      | { "" : true, "$flags" : { "$numberInt" : "2" } }
 2      | { "" : { "$maxKey" : 1 }, "$flags" : { "$numberInt" : "1" } }
 3      | { "$" : "Apple", "$flags" : { "$numberInt" : "0" } }
 4      | { "$" : "applezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz", "$flags" : { "$numberInt" : "0" } }
 5      | { "$" : "applezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz", "$flags" : { "$numberInt" : "1" } }
 6      | { "$" : "banana", "$flags" : { "$numberInt" : "0" } }
(6 rows)

-- ===== Documents inserted BEFORE index creation (index build) ======
SELECT documentdb_api.insert_one('coll_idx_db', 'coll_build_test', '{"_id": 1, "name": "Apple"}', NULL);
NOTICE:  creating collection
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_build_test', '{"_id": 2, "name": "apple"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_build_test', '{"_id": 3, "name": "APPLE"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_build_test', '{"_id": 4, "name": "Banana"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_build_test', '{"_id": 5, "name": "banana"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_build_test', '{"_id": 6, "name": "cherry"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_build_test', '{"_id": 7, "name": "Cherry"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_build_test', '{"_id": 8, "name": "CHERRY"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Now create the collation-aware index on existing documents
SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'coll_idx_db',
  '{
    "createIndexes": "coll_build_test",
    "indexes": [{
      "key": { "name": 1 },
      "name": "name_build_collated_idx",
      "collation": { "locale": "en", "strength": 1 }
    }]
  }',
  TRUE
);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

\d documentdb_data.documents_8011
          Table "documentdb_data.documents_8011"
     Column      |  Type  | Collation | Nullable | Default 
-----------------+--------+-----------+----------+---------
 shard_key_value | bigint |           | not null | 
 object_id       | bson   |           | not null | 
 document        | bson   |           | not null | 
Indexes:
    "collection_pk_8011" PRIMARY KEY, btree (shard_key_value, object_id)
    "documents_rum_index_8022" documentdb_extended_rum (document documentdb_extended_rum_catalog.bson_extended_rum_single_path_ops (path=name, tl='2699', "collation"='en-u-ks-level1'))
Check constraints:
    "shard_key_value_check" CHECK (shard_key_value = '8011'::bigint)

-- Strength=1 index build: 8 docs produce 5 entries - Apple/apple/APPLE, Banana/banana, cherry/Cherry/CHERRY collapsed
SELECT entry->>'offset' AS offset,
       collation_index_test_schema.gin_bson_index_term_to_bson((entry->>'firstEntry')::bytea) AS index_term
FROM documentdb_api_internal.documentdb_rum_page_get_entries(
    public.get_raw_page('documentdb_data.documents_rum_index_8022', 1), 
    'documentdb_data.documents_rum_index_8022'::regclass
) entry;
 offset |                      index_term                       
--------+-------------------------------------------------------
 1      | { "" : true, "$flags" : { "$numberInt" : "2" } }
 2      | { "$" : "Apple", "$flags" : { "$numberInt" : "0" } }
 3      | { "$" : "Banana", "$flags" : { "$numberInt" : "0" } }
 4      | { "$" : "cherry", "$flags" : { "$numberInt" : "0" } }
(4 rows)

-- ===== Index build with strength=3 (case-sensitive) ======
SELECT documentdb_api.insert_one('coll_idx_db', 'coll_build_s3', '{"_id": 1, "name": "Apple"}', NULL);
NOTICE:  creating collection
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_build_s3', '{"_id": 2, "name": "apple"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_build_s3', '{"_id": 3, "name": "APPLE"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_build_s3', '{"_id": 4, "name": "Banana"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_build_s3', '{"_id": 5, "name": "banana"}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'coll_idx_db',
  '{
    "createIndexes": "coll_build_s3",
    "indexes": [{
      "key": { "name": 1 },
      "name": "name_build_s3_idx",
      "collation": { "locale": "en", "strength": 3 }
    }]
  }',
  TRUE
);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

\d documentdb_data.documents_8012
          Table "documentdb_data.documents_8012"
     Column      |  Type  | Collation | Nullable | Default 
-----------------+--------+-----------+----------+---------
 shard_key_value | bigint |           | not null | 
 object_id       | bson   |           | not null | 
 document        | bson   |           | not null | 
Indexes:
    "collection_pk_8012" PRIMARY KEY, btree (shard_key_value, object_id)
    "documents_rum_index_8024" documentdb_extended_rum (document documentdb_extended_rum_catalog.bson_extended_rum_single_path_ops (path=name, tl='2699', "collation"='en-u-ks-level3'))
Check constraints:
    "shard_key_value_check" CHECK (shard_key_value = '8012'::bigint)

-- Strength=3 index build: 5 docs produce 7 entries - apple, Apple, APPLE, Banana, banana each distinct
SELECT entry->>'offset' AS offset,
       collation_index_test_schema.gin_bson_index_term_to_bson((entry->>'firstEntry')::bytea) AS index_term
FROM documentdb_api_internal.documentdb_rum_page_get_entries(
    public.get_raw_page('documentdb_data.documents_rum_index_8024', 1), 
    'documentdb_data.documents_rum_index_8024'::regclass
) entry;
 offset |                      index_term                       
--------+-------------------------------------------------------
 1      | { "" : true, "$flags" : { "$numberInt" : "2" } }
 2      | { "$" : "apple", "$flags" : { "$numberInt" : "0" } }
 3      | { "$" : "Apple", "$flags" : { "$numberInt" : "0" } }
 4      | { "$" : "APPLE", "$flags" : { "$numberInt" : "0" } }
 5      | { "$" : "banana", "$flags" : { "$numberInt" : "0" } }
 6      | { "$" : "Banana", "$flags" : { "$numberInt" : "0" } }
(6 rows)

-- ===== Partial filter expression with wildcard on details.$** ======
SELECT documentdb_api.insert_one('coll_idx_db', 'coll_partial', '{"_id": 1, "name": "Apple", "status": "Active", "details": {"items": ["apple", "banana", "cherry"], "info": {"city": "austin", "country": "usa"}}}', NULL);
NOTICE:  creating collection
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_partial', '{"_id": 2, "name": "apple", "status": "INACTIVE", "details": {"items": ["APPLE", "BANANA", "CHERRY"], "info": {"city": "AUSTIN", "country": "USA"}}}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_partial', '{"_id": 3, "name": "APPLE", "status": "ACTIVE", "details": {"items": ["Apple", "Banana", "Cherry"], "info": {"city": "Austin", "country": "Usa"}}}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_partial', '{"_id": 4, "name": "Banana", "status": "active", "details": {"items": ["aPPLE", "bANANA", "cHERRY"], "info": {"city": "aUSTIN", "country": "uSA"}}}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_partial', '{"_id": 5, "name": "banana", "status": "Inactive", "details": {"items": ["APPle", "BANana", "CHErry"], "info": {"city": "AUSTin", "country": "UsA"}}}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_partial', '{"_id": 6, "name": "cherry", "status": "aCTIVE", "details": {"items": ["applE", "bananA", "cherrY"], "info": {"city": "austiN", "country": "usA"}}}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Create single-path index on name and wildcard index on details.$**
SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'coll_idx_db',
  '{
    "createIndexes": "coll_partial",
    "indexes": [
      {
        "key": { "name": 1 },
        "name": "name_partial_s1_idx",
        "collation": { "locale": "en", "strength": 1 },
        "partialFilterExpression": { "status": "active" }
      },
      {
        "key": { "details.$**": 1 },
        "name": "details_wildcard_s1_idx",
        "collation": { "locale": "en", "strength": 1 },
        "partialFilterExpression": { "status": "active" }
      }
    ]
  }',
  TRUE
);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "3" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

\d documentdb_data.documents_8013
          Table "documentdb_data.documents_8013"
     Column      |  Type  | Collation | Nullable | Default 
-----------------+--------+-----------+----------+---------
 shard_key_value | bigint |           | not null | 
 object_id       | bson   |           | not null | 
 document        | bson   |           | not null | 
Indexes:
    "collection_pk_8013" PRIMARY KEY, btree (shard_key_value, object_id)
    "documents_rum_index_8026" documentdb_extended_rum (document documentdb_extended_rum_catalog.bson_extended_rum_single_path_ops (path=name, tl='2699', "collation"='en-u-ks-level1')) WHERE document #= '{ "status" : "active", "collation" : "en-u-ks-level1" }'::bsonquery
    "documents_rum_index_8027" documentdb_extended_rum (document documentdb_extended_rum_catalog.bson_extended_rum_single_path_ops (path=details, iswildcard='true', tl='2699', "collation"='en-u-ks-level1')) WHERE document #= '{ "status" : "active", "collation" : "en-u-ks-level1" }'::bsonquery
Check constraints:
    "shard_key_value_check" CHECK (shard_key_value = '8013'::bigint)

-- Show index info
SELECT (index_spec).index_name,
       documentdb_core.bson_get_value_text((index_spec).index_options, 'collation') AS collation
FROM documentdb_api_catalog.collection_indexes
WHERE collection_id = (SELECT collection_id FROM documentdb_api_catalog.collections 
                       WHERE database_name = 'coll_idx_db' AND collection_name = 'coll_partial')
ORDER BY index_id;
       index_name        |              collation              
-------------------------+-------------------------------------
 _id_                    | 
 name_partial_s1_idx     | { "locale" : "en", "strength" : 1 }
 details_wildcard_s1_idx | { "locale" : "en", "strength" : 1 }
(3 rows)

-- Strength=1 partial: only 4 entries (Apple, Banana, cherry) for docs where status="active" (case-insensitive match)
SELECT entry->>'offset' AS offset,
       collation_index_test_schema.gin_bson_index_term_to_bson((entry->>'firstEntry')::bytea) AS index_term
FROM documentdb_api_internal.documentdb_rum_page_get_entries(
    public.get_raw_page('documentdb_data.documents_rum_index_8026', 1), 
    'documentdb_data.documents_rum_index_8026'::regclass
) entry;
 offset |                      index_term                       
--------+-------------------------------------------------------
 1      | { "" : true, "$flags" : { "$numberInt" : "2" } }
 2      | { "$" : "Apple", "$flags" : { "$numberInt" : "0" } }
 3      | { "$" : "Banana", "$flags" : { "$numberInt" : "0" } }
 4      | { "$" : "cherry", "$flags" : { "$numberInt" : "0" } }
(4 rows)

-- Strength=1 wildcard partial: nested details.$** indexed for docs where status="active"
SELECT entry->>'offset' AS offset,
       collation_index_test_schema.gin_bson_index_term_to_bson((entry->>'firstEntry')::bytea) AS index_term
FROM documentdb_api_internal.documentdb_rum_page_get_entries(
    public.get_raw_page('documentdb_data.documents_rum_index_8027', 1), 
    'documentdb_data.documents_rum_index_8027'::regclass
) entry;
 offset |                                                                  index_term                                                                   
--------+-----------------------------------------------------------------------------------------------------------------------------------------------
 1      | { "" : true, "$flags" : { "$numberInt" : "2" } }
 2      | { "$" : { "items" : [ "apple", "banana", "cherry" ], "info" : { "city" : "austin", "country" : "usa" } }, "$flags" : { "$numberInt" : "0" } }
 3      | { "$.info" : { "city" : "austin", "country" : "usa" }, "$flags" : { "$numberInt" : "0" } }
 4      | { "$.info.city" : "austin", "$flags" : { "$numberInt" : "0" } }
 5      | { "$.info.country" : "usa", "$flags" : { "$numberInt" : "0" } }
 6      | { "$.items" : "apple", "$flags" : { "$numberInt" : "0" } }
 7      | { "$.items" : "banana", "$flags" : { "$numberInt" : "0" } }
 8      | { "$.items" : "cherry", "$flags" : { "$numberInt" : "0" } }
 9      | { "$.items" : [ "apple", "banana", "cherry" ], "$flags" : { "$numberInt" : "0" } }
 10     | { "$.items.0" : "apple", "$flags" : { "$numberInt" : "0" } }
 11     | { "$.items.1" : "banana", "$flags" : { "$numberInt" : "0" } }
 12     | { "$.items.2" : "cherry", "$flags" : { "$numberInt" : "0" } }
(12 rows)

-- ===== Partial filter expression with strength=3 (case-sensitive) ======
SELECT documentdb_api.insert_one('coll_idx_db', 'coll_partial_s3', '{"_id": 1, "name": "Apple", "status": "Active", "details": {"items": ["apple", "banana", "cherry"], "info": {"city": "austin", "country": "usa"}}}', NULL);
NOTICE:  creating collection
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_partial_s3', '{"_id": 2, "name": "apple", "status": "INACTIVE", "details": {"items": ["APPLE", "BANANA", "CHERRY"], "info": {"city": "AUSTIN", "country": "USA"}}}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_partial_s3', '{"_id": 3, "name": "APPLE", "status": "ACTIVE", "details": {"items": ["Apple", "Banana", "Cherry"], "info": {"city": "Austin", "country": "Usa"}}}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_partial_s3', '{"_id": 4, "name": "Banana", "status": "active", "details": {"items": ["aPPLE", "bANANA", "cHERRY"], "info": {"city": "aUSTIN", "country": "uSA"}}}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_partial_s3', '{"_id": 5, "name": "banana", "status": "Inactive", "details": {"items": ["APPle", "BANana", "CHErry"], "info": {"city": "AUSTin", "country": "UsA"}}}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('coll_idx_db', 'coll_partial_s3', '{"_id": 6, "name": "cherry", "status": "aCTIVE", "details": {"items": ["applE", "bananA", "cherrY"], "info": {"city": "austiN", "country": "usA"}}}', NULL);
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'coll_idx_db',
  '{
    "createIndexes": "coll_partial_s3",
    "indexes": [
      {
        "key": { "name": 1 },
        "name": "name_partial_s3_idx",
        "collation": { "locale": "en", "strength": 3 },
        "partialFilterExpression": { "status": "active" }
      },
      {
        "key": { "details.$**": 1 },
        "name": "details_wildcard_s3_idx",
        "collation": { "locale": "en", "strength": 3 },
        "partialFilterExpression": { "status": "active" }
      }
    ]
  }',
  TRUE
);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "3" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

\d documentdb_data.documents_8014
          Table "documentdb_data.documents_8014"
     Column      |  Type  | Collation | Nullable | Default 
-----------------+--------+-----------+----------+---------
 shard_key_value | bigint |           | not null | 
 object_id       | bson   |           | not null | 
 document        | bson   |           | not null | 
Indexes:
    "collection_pk_8014" PRIMARY KEY, btree (shard_key_value, object_id)
    "documents_rum_index_8029" documentdb_extended_rum (document documentdb_extended_rum_catalog.bson_extended_rum_single_path_ops (path=name, tl='2699', "collation"='en-u-ks-level3')) WHERE document #= '{ "status" : "active", "collation" : "en-u-ks-level3" }'::bsonquery
    "documents_rum_index_8030" documentdb_extended_rum (document documentdb_extended_rum_catalog.bson_extended_rum_single_path_ops (path=details, iswildcard='true', tl='2699', "collation"='en-u-ks-level3')) WHERE document #= '{ "status" : "active", "collation" : "en-u-ks-level3" }'::bsonquery
Check constraints:
    "shard_key_value_check" CHECK (shard_key_value = '8014'::bigint)

-- Show index info
SELECT (index_spec).index_name,
       documentdb_core.bson_get_value_text((index_spec).index_options, 'collation') AS collation
FROM documentdb_api_catalog.collection_indexes
WHERE collection_id = (SELECT collection_id FROM documentdb_api_catalog.collections 
                       WHERE database_name = 'coll_idx_db' AND collection_name = 'coll_partial_s3')
ORDER BY index_id;
       index_name        |              collation              
-------------------------+-------------------------------------
 _id_                    | 
 name_partial_s3_idx     | { "locale" : "en", "strength" : 3 }
 details_wildcard_s3_idx | { "locale" : "en", "strength" : 3 }
(3 rows)

-- Strength=3 partial: only 2 entries (Banana) - only doc with exact status="active" indexed
SELECT entry->>'offset' AS offset,
       collation_index_test_schema.gin_bson_index_term_to_bson((entry->>'firstEntry')::bytea) AS index_term
FROM documentdb_api_internal.documentdb_rum_page_get_entries(
    public.get_raw_page('documentdb_data.documents_rum_index_8029', 1), 
    'documentdb_data.documents_rum_index_8029'::regclass
) entry;
 offset |                      index_term                       
--------+-------------------------------------------------------
 1      | { "" : true, "$flags" : { "$numberInt" : "2" } }
 2      | { "$" : "Banana", "$flags" : { "$numberInt" : "0" } }
(2 rows)

-- Strength=3 wildcard partial: nested details.$** indexed only for doc with exact status="active"
SELECT entry->>'offset' AS offset,
       collation_index_test_schema.gin_bson_index_term_to_bson((entry->>'firstEntry')::bytea) AS index_term
FROM documentdb_api_internal.documentdb_rum_page_get_entries(
    public.get_raw_page('documentdb_data.documents_rum_index_8030', 1), 
    'documentdb_data.documents_rum_index_8030'::regclass
) entry;
 offset |                                                                  index_term                                                                   
--------+-----------------------------------------------------------------------------------------------------------------------------------------------
 1      | { "" : true, "$flags" : { "$numberInt" : "2" } }
 2      | { "$" : { "items" : [ "aPPLE", "bANANA", "cHERRY" ], "info" : { "city" : "aUSTIN", "country" : "uSA" } }, "$flags" : { "$numberInt" : "0" } }
 3      | { "$.info" : { "city" : "aUSTIN", "country" : "uSA" }, "$flags" : { "$numberInt" : "0" } }
 4      | { "$.info.city" : "aUSTIN", "$flags" : { "$numberInt" : "0" } }
 5      | { "$.info.country" : "uSA", "$flags" : { "$numberInt" : "0" } }
 6      | { "$.items" : "aPPLE", "$flags" : { "$numberInt" : "0" } }
 7      | { "$.items" : "bANANA", "$flags" : { "$numberInt" : "0" } }
 8      | { "$.items" : "cHERRY", "$flags" : { "$numberInt" : "0" } }
 9      | { "$.items" : [ "aPPLE", "bANANA", "cHERRY" ], "$flags" : { "$numberInt" : "0" } }
 10     | { "$.items.0" : "aPPLE", "$flags" : { "$numberInt" : "0" } }
 11     | { "$.items.1" : "bANANA", "$flags" : { "$numberInt" : "0" } }
 12     | { "$.items.2" : "cHERRY", "$flags" : { "$numberInt" : "0" } }
(12 rows)

DROP SCHEMA collation_index_test_schema CASCADE;
NOTICE:  drop cascades to function collation_index_test_schema.gin_bson_index_term_to_bson(bytea)
RESET documentdb.enableCollationWithIndexes;
RESET documentdb_core.enableCollation;
