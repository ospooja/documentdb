SET search_path TO documentdb_api,documentdb_api_catalog,documentdb_core;
SET documentdb.next_collection_id TO 1430;
SET documentdb.next_collection_index_id TO 1430;
SET citus.next_shard_id TO 143000;
-- Insert test data for hashed aggregates
SELECT * FROM documentdb_api.insert_one('testdb', 'hash_aggTest', '{ "_id": 1, "key": 1, "value": "abc" }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * FROM documentdb_api.insert_one('testdb', 'hash_aggTest', '{ "_id": 2, "key": 2, "value": "def" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT * FROM documentdb_api.insert_one('testdb', 'hash_aggTest', '{ "_id": 3, "key": 1, "value": "ghi" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Enforce hashed aggregate plans
SET enable_hashagg = on;
SET enable_sort = off;
SET enable_incremental_sort = off;
SET documentdb.defaultcursorfirstpagebatchsize = 1;
-- TEST each aggregate, TODO add more
SELECT cursorPage->'cursor.firstBatch' FROM aggregate_cursor_first_page('testdb', '{ "aggregate": "hash_aggTest", "pipeline": [ { "$group": { "_id": "$key", "items": { "$push": "$$ROOT" } } } ], "cursor" : {  } }');
                                                                                                                ?column?                                                                                                                 
---------------------------------------------------------------------
 { "" : [ { "_id" : { "$numberInt" : "1" }, "items" : [ { "_id" : { "$numberInt" : "1" }, "key" : { "$numberInt" : "1" }, "value" : "abc" }, { "_id" : { "$numberInt" : "3" }, "key" : { "$numberInt" : "1" }, "value" : "ghi" } ] } ] }
(1 row)

-- fails without enableAddToSetAggregationRewrite set to 'on'
SELECT cursorPage->'cursor.firstBatch' FROM aggregate_cursor_first_page('testdb', '{ "aggregate": "hash_aggTest", "pipeline": [ { "$group": { "_id": "$key", "items": { "$addToSet": "$$ROOT" } } } ], "cursor" : {  } }');
NOTICE:  There are open held portals. Closing them
                                                                                                                ?column?                                                                                                                 
---------------------------------------------------------------------
 { "" : [ { "_id" : { "$numberInt" : "1" }, "items" : [ { "_id" : { "$numberInt" : "1" }, "key" : { "$numberInt" : "1" }, "value" : "abc" }, { "_id" : { "$numberInt" : "3" }, "key" : { "$numberInt" : "1" }, "value" : "ghi" } ] } ] }
(1 row)

-- Check if we are really are doing hash aggregations
EXPLAIN (COSTS OFF, BUFFERS OFF, ANALYZE ON, TIMING OFF, SUMMARY OFF) SELECT * FROM bson_aggregation_pipeline('testdb', '{ "aggregate": "hash_aggTest", "pipeline": [ { "$group": { "_id": "$key", "items": { "$push": "$$ROOT" } } } ], "cursor" : {  } }');
                                                                                        QUERY PLAN                                                                                         
---------------------------------------------------------------------
 Subquery Scan on agg_stage_0 (actual rows=2 loops=1)
   ->  HashAggregate (actual rows=2 loops=1)
         Group Key: documentdb_api_internal.bson_expression_get(collection.document, '{ "" : "$key" }'::bson, true, '{ "now" : NOW_SYS_VARIABLE }'::bson)
         Batches: 1  Memory Usage: 24kB
         ->  Bitmap Heap Scan on documents_1431_143002 collection (actual rows=3 loops=1)
               Recheck Cond: (shard_key_value = '1431'::bigint)
               Heap Blocks: exact=1
               ->  Bitmap Index Scan on _id_ (actual rows=3 loops=1)
                     Index Cond: (shard_key_value = '1431'::bigint)
(9 rows)

EXPLAIN (COSTS OFF, BUFFERS OFF, ANALYZE ON, TIMING OFF, SUMMARY OFF) SELECT * FROM bson_aggregation_pipeline('testdb', '{ "aggregate": "hash_aggTest", "pipeline": [ { "$group": { "_id": "$key", "items": { "$addToSet": "$$ROOT" } } } ], "cursor" : {  } }');
                                                                                        QUERY PLAN                                                                                         
---------------------------------------------------------------------
 Subquery Scan on agg_stage_0 (actual rows=2 loops=1)
   ->  HashAggregate (actual rows=2 loops=1)
         Group Key: documentdb_api_internal.bson_expression_get(collection.document, '{ "" : "$key" }'::bson, true, '{ "now" : NOW_SYS_VARIABLE }'::bson)
         Batches: 1  Memory Usage: 24kB
         ->  Bitmap Heap Scan on documents_1431_143002 collection (actual rows=3 loops=1)
               Recheck Cond: (shard_key_value = '1431'::bigint)
               Heap Blocks: exact=1
               ->  Bitmap Index Scan on _id_ (actual rows=3 loops=1)
                     Index Cond: (shard_key_value = '1431'::bigint)
(9 rows)

RESET enable_hashagg;
RESET enable_sort;
RESET enable_incremental_sort;
RESET documentdb.defaultcursorfirstpagebatchsize;
