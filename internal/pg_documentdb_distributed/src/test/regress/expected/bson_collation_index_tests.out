SET search_path TO documentdb_core,documentdb_api,documentdb_api_catalog,documentdb_api_internal;
SET citus.next_shard_id TO 970000;
SET documentdb.next_collection_id TO 9700;
SET documentdb.next_collection_index_id TO 9700;
SET documentdb_core.enableCollation TO on;
SET documentdb.enableCollationWithIndexes TO off;
SET documentdb_api.forceUseIndexIfAvailable to on;
ALTER SYSTEM SET documentdb_core.enablecollation='on';
SELECT pg_reload_conf();
 pg_reload_conf 
---------------------------------------------------------------------
 t
(1 row)

-- ======== SECTION 0: Unsupported index types with collation ========
-- text indexes: unsupported with collation
SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'db',
  '{
     "createIndexes": "coll_index_0",
     "indexes": [
        {
         "key": {"a": "text"}, "name": "index_0_a_text",
         "collation" : {"locale" : "en", "strength" : 1}
        }
     ]
   }',
   TRUE
);
ERROR:  Error in specification { "key" : { "a" : "text" }, "name" : "index_0_a_text", "collation" : { "locale" : "en", "strength" : 1 } }:createIndex.collation is not implemented yet
-- 2d indexes: unsupported with collation
SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'db',
  '{
     "createIndexes": "coll_index_0",
     "indexes": [
        {
         "key": {"a": "2d"}, "name": "index_0_a_2d",
         "collation" : {"locale" : "en", "strength" : 1}
        }
     ]
   }',
   TRUE
);
ERROR:  Error in specification { "key" : { "a" : "2d" }, "name" : "index_0_a_2d", "collation" : { "locale" : "en", "strength" : 1 } }:createIndex.collation is not implemented yet
-- hash indexes: unsupported with collation YET
SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'db',
  '{
     "createIndexes": "coll_index_0",
     "indexes": [
        {
         "key": {"a": "hashed"}, "name": "index_0_a_hashed",
         "collation" : {"locale" : "en", "strength" : 1}
        }
     ]
   }',
   TRUE
);
ERROR:  Error in specification { "key" : { "a" : "hashed" }, "name" : "index_0_a_hashed", "collation" : { "locale" : "en", "strength" : 1 } }:createIndex.collation is not implemented yet
-- ======== SECTION 1: Single-path index tests on coll_index_1 ========
SELECT documentdb_api.insert_one('db','coll_index_1', '{"_id": 1, "a" : "DOG" }', NULL);
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','coll_index_1', '{"_id": 2, "a" : "dog" }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','coll_index_1', '{"_id": 3, "a" : "Cat" }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db','coll_index_1', '{"_id": 4, "a" : "Dog" }', NULL);
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- single path indexes
-- non-concurrent index creation
SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'db',
  '{
     "createIndexes": "coll_index_1",
     "indexes": [
       {
         "key": {"a": 1}, "name": "index_1_a",
         "collation" : {"locale" : "en", "strength" : 1}
       }
     ]
   }',
   TRUE
);
ERROR:  Error in specification { "key" : { "a" : 1 }, "name" : "index_1_a", "collation" : { "locale" : "en", "strength" : 1 } }:createIndex.collation is not implemented yet
-- no collation: index not used
-- find
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_1", "filter": { "a": { "$eq": "dog" } }, "sort": { "_id": 1 } }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : "dog" }
(1 row)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_1", "filter": { "a": { "$eq": "dog" } }, "sort": { "_id": 1 } }');
                                                                                                                                                                                                                                                  QUERY PLAN                                                                                                                                                                                                                                                  
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9700_970005 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "dog" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '9700'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_catalog.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_catalog.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Sort Key: (documentdb_api_catalog.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_9700_970005 collection
                     Output: document, documentdb_api_catalog.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)
                     Recheck Cond: (collection.shard_key_value = '9700'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "dog" }'::documentdb_core.bson)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '9700'::bigint)
(16 rows)

ROLLBACK;
-- aggregate
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_1", "pipeline": [ { "$sort": { "_id": 1 } }, { "$addFields": { "x": "mANgO" } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                            document                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "DOG", "x" : "mANgO" }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog", "x" : "mANgO" }
 { "_id" : { "$numberInt" : "3" }, "a" : "Cat", "x" : "mANgO" }
 { "_id" : { "$numberInt" : "4" }, "a" : "Dog", "x" : "mANgO" }
(4 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_1", "pipeline": [ { "$sort": { "_id": 1 } }, { "$addFields": { "x": "mANgO" } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_add_fields(document, '{ "x" : "mANgO" }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS document FROM documentdb_data.documents_9700_970005 collection WHERE ((shard_key_value OPERATOR(pg_catalog.=) '9700'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: (documentdb_api_internal.bson_dollar_add_fields(document, '{ "x" : "mANgO" }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text)), (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_9700_970005 collection
                     Output: documentdb_api_internal.bson_dollar_add_fields(document, '{ "x" : "mANgO" }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text), documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Recheck Cond: (collection.shard_key_value = '9700'::bigint)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '9700'::bigint)
(15 rows)

ROLLBACK;
BEGIN;
-- different collation than index: index not used
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_1", "filter": { "a": { "$eq": "dog" } }, "sort": { "_id": 1 }, "collation": { "locale": "de", "strength" : 1} }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "DOG" }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "Dog" }
(3 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_1", "filter": { "a": { "$eq": "dog" } }, "sort": { "_id": 1 }, "collation": { "locale": "de", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                    QUERY PLAN                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9700_970005 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "dog", "collation" : "de-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '9700'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'de-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'de-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'de-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_9700_970005 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'de-u-ks-level1'::text)
                     Recheck Cond: (collection.shard_key_value = '9700'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "dog", "collation" : "de-u-ks-level1" }'::documentdb_core.bson)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '9700'::bigint)
(16 rows)

ROLLBACK;
BEGIN;
-- same collation as index : index used
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_1", "filter": { "a": { "$eq": "dog" } }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength" : 1} }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "DOG" }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "Dog" }
(3 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_1", "filter": { "a": { "$eq": "dog" } }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                    QUERY PLAN                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9700_970005 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '9700'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_9700_970005 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Recheck Cond: (collection.shard_key_value = '9700'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '9700'::bigint)
(16 rows)

ROLLBACK;
BEGIN;
-- deleteOne
SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_1",
     "filter": { "a": { "$gt": "Cat" } },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "DOG" }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "Dog" }
(3 rows)

SELECT documentdb_api.delete('db',
  '{ "delete": "coll_index_1",
     "deletes": [
       { "q": { "_id": 1, "a": { "$gt": "Cat" } },
         "limit": 1,
         "collation": { "locale": "en", "strength": 1 }
       }
     ]
   }');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_1",
     "filter": { "a": { "$gt": "Cat" } },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "Dog" }
(2 rows)

ROLLBACK;
BEGIN;
-- deleteMany
SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_1",
     "filter": { "$or": [{ "a": { "$lt": "DOG" } }, { "a": { "$gte": "Dog" } }] },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
                    document                     
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "DOG" }
 { "_id" : { "$numberInt" : "2" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "3" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "4" }, "a" : "Dog" }
(4 rows)

SELECT documentdb_api.delete('db',
  '{ "delete": "coll_index_1",
     "deletes": [
       { "q": { "a": { "$lt": "DOG" } },
         "limit": 0,
         "collation": { "locale": "en", "strength": 1 }
       },
       { "q": { "a": { "$gte": "Dog" } },
         "limit": 0,
         "collation": { "locale": "en", "strength": 1 }
       }
     ]
   }');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""4"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_1",
     "filter": { "$or": [{ "a": { "$lt": "DOG" } }, { "a": { "$gte": "Dog" } }] },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
-- ======== SECTION 2: Single-path index tests on coll_index_2 (unsharded) ========
-- (1) insert some docs
SELECT documentdb_api.insert_one('db', 'coll_index_2', '{ "_id": 1, "a": "Cat" }');
NOTICE:  creating collection
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_index_2', '{ "_id": 2, "a": "cat" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_index_2', '{ "_id": 3, "a": "Dog" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_index_2', '{ "_id": 4, "a": "dog" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_index_2', '{ "_id": 5, "a": { "b" : "cAt"} }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_index_2', '{ "_id": 6, "a": ["Cat", "cat", "dog"] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_index_2', '{ "_id": 7, "a": [{ "b": "CAT"}] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_index_2', '{ "_id": 9, "a": "Dog", "b": "Chien" }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_index_2', '{ "_id": 10, "a": "cat", "b": ["Chien", "Chat"] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_index_2', '{ "_id": 11, "a": "dog", "c": "kraman"  }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_index_2', '{ "_id": 12, "a": "cat", "c":{ "d": "Okra" } }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_index_2', '{ "_id": 13, "a": "cat", "c":[ "Okra", "Kraman", "okra" ] }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('db', 'coll_index_2', '{ "_id": 14, "a": "cat", "b": {"c": "chat"} }');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'db',
  '{
     "createIndexes": "coll_index_2",
     "indexes": [
       {
         "key": {"a": 1}, "name": "index_2_a",
         "collation" : {"locale" : "en", "strength" : 1}
       }
     ]
   }',
   TRUE
);
ERROR:  Error in specification { "key" : { "a" : 1 }, "name" : "index_2_a", "collation" : { "locale" : "en", "strength" : 1 } }:createIndex.collation is not implemented yet
-- find: unsharded
BEGIN;
-- $eq
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(7 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                    QUERY PLAN                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970020 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
(16 rows)

ROLLBACK;
BEGIN;
-- $lt
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$lt": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$lt": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                    QUERY PLAN                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970020 collection WHERE ((document OPERATOR(documentdb_api_catalog.#<) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@<) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
(16 rows)

ROLLBACK;
BEGIN;
-- $gt
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$gt": "CAT", "$lt" : "RABBIT"} }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength" : 1 } }');
                             document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
(5 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$gt": "CAT", "$lt" : "RABBIT"} }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength" : 1 } }');
                                                                                                                                                                                                                                                                                                                                                                       QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                       
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970020 collection WHERE (((document OPERATOR(documentdb_api_catalog.#>) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#<) '{ "a" : "RABBIT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery)) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@>) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@<) '{ "a" : "RABBIT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
(16 rows)

ROLLBACK;
BEGIN;
-- $gte
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$gte": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(11 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$gte": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970020 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@>=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
(16 rows)

ROLLBACK;
BEGIN;
-- $in
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a" : {"$in" : ["cat", "DOG" ] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 100, "collation": { "locale": "en", "strength" : 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(11 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a" : {"$in" : ["cat", "DOG" ] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 100, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                                                                                                                                                                QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970020 collection WHERE ((documentdb_api_catalog.bson_dollar_in(document, '{ "a" : [ "cat", "DOG" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_internal.##=) ANY (ARRAY['{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_api_internal.bsonindexbounds, '{ "a" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_api_internal.bsonindexbounds]))) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '100'::bigint
         Node: host=localhost port=58070 dbname=regression
         ->  Limit
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               ->  Sort
                     Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                     Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                     ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                           Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                           Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                           Filter: (collection.document OPERATOR(documentdb_api_catalog.@*=) '{ "a" : [ "cat", "DOG" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                           ->  Bitmap Index Scan on _id_
                                 Index Cond: (collection.shard_key_value = '9701'::bigint)
(18 rows)

ROLLBACK;
BEGIN;
-- $in with regex
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$in": [{"$regex": "DOG", "$options": ""}, {"$regex": "CAT", "$options": ""}, "dog"] } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
                             document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
(5 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$in": [{"$regex": "DOG", "$options": ""}, {"$regex": "CAT", "$options": ""}, "dog"] } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                                                       QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                       
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970020 collection WHERE (documentdb_api_catalog.bson_dollar_in(document, '{ "a" : [ { "$regularExpression" : { "pattern" : "DOG", "options" : "" } }, { "$regularExpression" : { "pattern" : "CAT", "options" : "" } }, "dog" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@*=) '{ "a" : [ { "$regularExpression" : { "pattern" : "DOG", "options" : "" } }, { "$regularExpression" : { "pattern" : "CAT", "options" : "" } }, "dog" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
(16 rows)

ROLLBACK;
BEGIN;
-- $nin
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a" : {"$nin" : ["cat", "DOG" ] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 100, "collation": { "locale": "en", "strength" : 1} }');
                           document                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : "cAt" } }
 { "_id" : { "$numberInt" : "7" }, "a" : [ { "b" : "CAT" } ] }
(2 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a" : {"$in" : ["cat", "DOG" ] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 100, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                                                                                                                                                                QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970020 collection WHERE ((documentdb_api_catalog.bson_dollar_in(document, '{ "a" : [ "cat", "DOG" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_internal.##=) ANY (ARRAY['{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_api_internal.bsonindexbounds, '{ "a" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_api_internal.bsonindexbounds]))) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '100'::bigint
         Node: host=localhost port=58070 dbname=regression
         ->  Limit
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               ->  Sort
                     Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                     Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                     ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                           Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                           Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                           Filter: (collection.document OPERATOR(documentdb_api_catalog.@*=) '{ "a" : [ "cat", "DOG" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                           ->  Bitmap Index Scan on _id_
                                 Index Cond: (collection.shard_key_value = '9701'::bigint)
(18 rows)

ROLLBACK;
BEGIN;
-- $nin with regex
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$nin": [{"$regex": "DOG", "$options": ""}, {"$regex": "CAT", "$options": ""}, "dog"] } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : "cAt" } }
 { "_id" : { "$numberInt" : "7" }, "a" : [ { "b" : "CAT" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(8 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$nin": [{"$regex": "DOG", "$options": ""}, {"$regex": "CAT", "$options": ""}, "dog"] } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                                                       QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                        
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970020 collection WHERE (documentdb_api_catalog.bson_dollar_nin(document, '{ "a" : [ { "$regularExpression" : { "pattern" : "DOG", "options" : "" } }, { "$regularExpression" : { "pattern" : "CAT", "options" : "" } }, "dog" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@!*=) '{ "a" : [ { "$regularExpression" : { "pattern" : "DOG", "options" : "" } }, { "$regularExpression" : { "pattern" : "CAT", "options" : "" } }, "dog" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
(16 rows)

ROLLBACK;
BEGIN;
-- $all: basic test with two values (case-insensitive match)
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$all": ["cAt", "DOG"] } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
                             document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
(1 row)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$all": ["cAt", "DOG"] } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970020 collection WHERE (((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cAt", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery)) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cAt", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
(16 rows)

ROLLBACK;
BEGIN;
-- $all: single value (equivalent to $eq for arrays)
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$all": ["CAT"] } }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(7 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$all": ["CAT"] } }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                    QUERY PLAN                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970020 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
(16 rows)

ROLLBACK;
BEGIN;
-- $all: on scalar field should return empty when multiple distinct values required
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "_id": 1, "a": { "$all": ["CAT", "DOG"] } }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
BEGIN;
-- $all: three values with case variations - tests AND semantics are preserved
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$all": ["CAT", "cat", "DOG"] } }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1} }');
                             document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
(1 row)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$all": ["CAT", "cat", "DOG"] } }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970020 collection WHERE (((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery)) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
(16 rows)

ROLLBACK;
BEGIN;
-- $all: no matches (value not in any document)
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$all": ["ELEPHANT", "LION"] } }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
BEGIN;
-- $all: combined with $and on different field
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and": [{ "a": { "$all": ["CAT"] } }, { "b": { "$exists": true } }] }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1} }');
                                  document                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(2 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and": [{ "a": { "$all": ["CAT"] } }, { "b": { "$exists": true } }] }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                                                            QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                            
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970020 collection WHERE (((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#>=) '{ "b" : { "$minKey" : 1 }, "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery)) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@>=) '{ "b" : { "$minKey" : 1 }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
(16 rows)

ROLLBACK;
BEGIN;
-- $all: combined with $or
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$or": [{ "a": { "$all": ["CAT", "DOG"] } }, { "_id": 1 }] }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1} }');
                             document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
(2 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$or": [{ "a": { "$all": ["CAT", "DOG"] } }, { "_id": 1 }] }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970020 collection WHERE ((((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery)) OR (document OPERATOR(documentdb_api_catalog.#=) '{ "_id" : { "$numberInt" : "1" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery)) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (((collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)) OR (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : { "$numberInt" : "1" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
(16 rows)

ROLLBACK;
BEGIN;
-- $all with regex
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$all": [{"$regex": "DOG", "$options": ""}, {"$regex": "CAT", "$options": ""}, "dog"] } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$all": [{"$regex": "DOG", "$options": ""}, {"$regex": "CAT", "$options": ""}, "dog"] } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970020 collection WHERE ((documentdb_api_catalog.bson_dollar_regex(document, '{ "a" : { "$regularExpression" : { "pattern" : "DOG", "options" : "" } }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND documentdb_api_catalog.bson_dollar_regex(document, '{ "a" : { "$regularExpression" : { "pattern" : "CAT", "options" : "" } }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery)) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@~) '{ "a" : { "$regularExpression" : { "pattern" : "DOG", "options" : "" } }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@~) '{ "a" : { "$regularExpression" : { "pattern" : "CAT", "options" : "" } }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
(16 rows)

ROLLBACK;
BEGIN;
-- $elemMatch
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$elemMatch": { "$eq": "CAT" } } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
                             document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
(1 row)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$elemMatch": { "$eq": "CAT" } } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                            QUERY PLAN                                                                                                                                                                                                                                                                                                             
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970020 collection WHERE (documentdb_api_catalog.bson_dollar_elemmatch(document, '{ "a" : { "$eq" : "CAT" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@#?) '{ "a" : { "$eq" : "CAT" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
(16 rows)

ROLLBACK;
BEGIN;
-- $elemMatch with range
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$elemMatch": { "$gte": "cat", "$lte": "dog" } } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
                             document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
(1 row)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$elemMatch": { "$gte": "cat", "$lte": "dog" } } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970020 collection WHERE (documentdb_api_catalog.bson_dollar_elemmatch(document, '{ "a" : { "$gte" : "cat", "$lte" : "dog" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@#?) '{ "a" : { "$gte" : "cat", "$lte" : "dog" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
(16 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$or" : [{ "a": { "$lte": "cat" } }, { "a": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(11 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$or" : [{ "a": { "$lte": "cat" } }, { "a": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970020 collection WHERE (((document OPERATOR(documentdb_api_catalog.#<=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) OR (document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery)) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@<=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) OR (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
(16 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "a": { "$gte": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 1 } }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "a": { "$gte": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 1 } }');
                                                                                                                                                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970020 collection WHERE (((document OPERATOR(documentdb_api_catalog.#>=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery)) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '10'::bigint
         Node: host=localhost port=58070 dbname=regression
         ->  Limit
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               ->  Sort
                     Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                     Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                     ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                           Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                           Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                           Filter: ((collection.document OPERATOR(documentdb_api_catalog.@>=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
                           ->  Bitmap Index Scan on _id_
                                 Index Cond: (collection.shard_key_value = '9701'::bigint)
(18 rows)

ROLLBACK;
-- aggregate: unsharded
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(7 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970020 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND ((shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
(16 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$gt": "DOG" } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$gt": "DOG" } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970020 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>) '{ "a" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND ((shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@>) '{ "a" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
(16 rows)

ROLLBACK;
BEGIN;
-- $match followed by $project
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" } } }, { "$project": { "a": 1, "_id": 0 } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
             document              
---------------------------------------------------------------------
 { "a" : "Cat" }
 { "a" : "cat" }
 { "a" : [ "Cat", "cat", "dog" ] }
 { "a" : "cat" }
 { "a" : "cat" }
 { "a" : "cat" }
 { "a" : "cat" }
(7 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" } } }, { "$project": { "a": 1, "_id": 0 } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                                                                                                                      QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                       
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "_id" : { "$numberInt" : "0" } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS document FROM documentdb_data.documents_9701_970020 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND ((shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: (documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "_id" : { "$numberInt" : "0" } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text)), (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                     Output: documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "_id" : { "$numberInt" : "0" } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text), documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
(16 rows)

ROLLBACK;
BEGIN;
-- $match then $unwind
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "dog" } } }, { "$unwind": "$a" } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
                             document                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "6" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "6" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "6" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
(7 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "dog" } } }, { "$unwind": "$a" } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                       QUERY PLAN                                                                                                                                                                                                                                                                                                                                       
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_catalog.bson_dollar_unwind(document, '$a'::text) AS document FROM documentdb_data.documents_9701_970020 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND ((shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  ProjectSet
               Output: documentdb_api_catalog.bson_dollar_unwind(document, '$a'::text), (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               ->  Result
                     Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                     ->  Sort
                           Output: (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)), document
                           Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                           ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                                 Output: documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text), document
                                 Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                                 Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                                 ->  Bitmap Index Scan on _id_
                                       Index Cond: (collection.shard_key_value = '9701'::bigint)
(20 rows)

ROLLBACK;
BEGIN;
-- $match then $addFields
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "dog" } } },  { "$addFields": { "x": "DOG" } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
                                    document                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog", "x" : "DOG" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog", "x" : "DOG" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ], "x" : "DOG" }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien", "x" : "DOG" }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman", "x" : "DOG" }
(5 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "dog" } } },  { "$addFields": { "x": "DOG" } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_add_fields(document, '{ "x" : "DOG" }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS document FROM documentdb_data.documents_9701_970020 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND ((shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: (documentdb_api_internal.bson_dollar_add_fields(document, '{ "x" : "DOG" }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text)), (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                     Output: documentdb_api_internal.bson_dollar_add_fields(document, '{ "x" : "DOG" }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text), documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                     ->  Bitmap Index Scan on _id_
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
(16 rows)

ROLLBACK;
BEGIN;
-- $sort after $match
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$in": ["cat", "dog"] } } }, { "$sort": { "_id": 1 } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(11 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$in": ["cat", "dog"] } } }, { "$sort": { "_id": 1 } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM (SELECT collection.document FROM documentdb_data.documents_9701_970020 collection WHERE ((documentdb_api_catalog.bson_dollar_in(collection.document, '{ "a" : [ "cat", "dog" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_internal.##=) ANY (ARRAY['{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_api_internal.bsonindexbounds, '{ "a" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_api_internal.bsonindexbounds]))) AND ((collection.shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))) ORDER BY (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST) agg_stage_2 ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: agg_stage_2.document, (documentdb_api_internal.bson_orderby(agg_stage_2.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(agg_stage_2.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Subquery Scan on agg_stage_2
                     Output: agg_stage_2.document, documentdb_api_internal.bson_orderby(agg_stage_2.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     ->  Sort
                           Output: collection.document, (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                           Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                           ->  Bitmap Heap Scan on documentdb_data.documents_9701_970020 collection
                                 Output: collection.document, documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                                 Recheck Cond: (collection.shard_key_value = '9701'::bigint)
                                 Filter: (collection.document OPERATOR(documentdb_api_catalog.@*=) '{ "a" : [ "cat", "dog" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
                                 ->  Bitmap Index Scan on _id_
                                       Index Cond: (collection.shard_key_value = '9701'::bigint)
(21 rows)

ROLLBACK;
BEGIN;
-- deleteOne
SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "a": { "$gte": "rabbit" } },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

SELECT documentdb_api.delete('db',
  '{ "delete": "coll_index_2",
     "deletes": [
       { "q": { "_id": 1, "a": { "$gte": "rabbit" } },
         "limit": 1,
         "collation": { "locale": "en", "strength": 1 }
       }
     ]
   }');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "a": { "$gte": "rabbit" } },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
BEGIN;
-- deleteMany
SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "$or": [{ "a": { "$in": ["CAT", "dog"] } }, { "a": { "$lte": "RABBIT" } }] },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(11 rows)

SELECT documentdb_api.delete('db',
  '{ "delete": "coll_index_2",
     "deletes": [
       { "q": { "a": { "$in": ["CAT", "dog"] } },
         "limit": 0,
         "collation": { "locale": "en", "strength": 1 }
       },
       { "q": { "a": { "$lte": "RABBIT" } },
         "limit": 0,
         "collation": { "locale": "en", "strength": 1 }
       }
     ]
   }');
                                         delete                                          
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""11"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "$or": [{ "a": { "$in": ["CAT", "dog"] } }, { "a": { "$lte": "RABBIT" } }] },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
-- ======== SECTION 3: Single-path index tests on coll_index_2 (sharded) ========
-- shard the collection
SELECT documentdb_api.shard_collection('db', 'coll_index_2', '{ "_id": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

-- find: sharded
BEGIN;
-- $eq
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(7 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970032 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
-- $lt
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$lt": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$lt": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970032 collection WHERE ((document OPERATOR(documentdb_api_catalog.#<) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@<) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
-- $gt
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$gt": "CAT", "$lt" : "RABBIT"} }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength" : 1 } }');
                             document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
(5 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$gt": "CAT", "$lt" : "RABBIT"} }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength" : 1 } }');
                                                                                                                                                                                                                                                                                                                QUERY PLAN                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970032 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#<) '{ "a" : "RABBIT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@>) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@<) '{ "a" : "RABBIT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(13 rows)

ROLLBACK;
BEGIN;
-- $gte
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$gte": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(11 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$gte": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970032 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@>=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
-- $in
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a" : {"$in" : ["cat", "DOG" ] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 100, "collation": { "locale": "en", "strength" : 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(11 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a" : {"$in" : ["cat", "DOG" ] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 100, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
---------------------------------------------------------------------
 Limit
   Output: remote_scan.document, remote_scan."?sort?"
   ->  Sort
         Output: remote_scan.document, remote_scan."?sort?"
         Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
         ->  Custom Scan (Citus Adaptive)
               Output: remote_scan.document, remote_scan."?sort?"
               Task Count: 8
               Tasks Shown: One of 8
               ->  Task
                     Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970032 collection WHERE (documentdb_api_catalog.bson_dollar_in(document, '{ "a" : [ "cat", "DOG" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_internal.##=) ANY ('{"{ \"a\" : \"cat\", \"collation\" : \"en-u-ks-level1\" }","{ \"a\" : \"DOG\", \"collation\" : \"en-u-ks-level1\" }"}'::documentdb_api_internal.bsonindexbounds[])) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '100'::bigint
                     Node: host=localhost port=58070 dbname=regression
                     ->  Limit
                           Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                           ->  Sort
                                 Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                                 Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                                 ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                                       Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                                       Filter: (collection.document OPERATOR(documentdb_api_catalog.@*=) '{ "a" : [ "cat", "DOG" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(20 rows)

ROLLBACK;
BEGIN;
-- $in with regex
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$in": [{"$regex": "DOG", "$options": ""}, {"$regex": "CAT", "$options": ""}, "dog"] } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
                             document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
(5 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$in": [{"$regex": "DOG", "$options": ""}, {"$regex": "CAT", "$options": ""}, "dog"] } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                 QUERY PLAN                                                                                                                                                                                                                                                                                                                 
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970032 collection WHERE (documentdb_api_catalog.bson_dollar_in(document, '{ "a" : [ { "$regularExpression" : { "pattern" : "DOG", "options" : "" } }, { "$regularExpression" : { "pattern" : "CAT", "options" : "" } }, "dog" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@*=) '{ "a" : [ { "$regularExpression" : { "pattern" : "DOG", "options" : "" } }, { "$regularExpression" : { "pattern" : "CAT", "options" : "" } }, "dog" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
-- $nin
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a" : {"$nin" : ["cat", "DOG" ] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 100, "collation": { "locale": "en", "strength" : 1} }');
                           document                            
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : "cAt" } }
 { "_id" : { "$numberInt" : "7" }, "a" : [ { "b" : "CAT" } ] }
(2 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a" : {"$in" : ["cat", "DOG" ] }}, "sort": { "_id": 1 }, "skip": 0, "limit": 100, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
---------------------------------------------------------------------
 Limit
   Output: remote_scan.document, remote_scan."?sort?"
   ->  Sort
         Output: remote_scan.document, remote_scan."?sort?"
         Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
         ->  Custom Scan (Citus Adaptive)
               Output: remote_scan.document, remote_scan."?sort?"
               Task Count: 8
               Tasks Shown: One of 8
               ->  Task
                     Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970032 collection WHERE (documentdb_api_catalog.bson_dollar_in(document, '{ "a" : [ "cat", "DOG" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_internal.##=) ANY ('{"{ \"a\" : \"cat\", \"collation\" : \"en-u-ks-level1\" }","{ \"a\" : \"DOG\", \"collation\" : \"en-u-ks-level1\" }"}'::documentdb_api_internal.bsonindexbounds[])) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '100'::bigint
                     Node: host=localhost port=58070 dbname=regression
                     ->  Limit
                           Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                           ->  Sort
                                 Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                                 Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                                 ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                                       Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                                       Filter: (collection.document OPERATOR(documentdb_api_catalog.@*=) '{ "a" : [ "cat", "DOG" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(20 rows)

ROLLBACK;
BEGIN;
-- $nin with regex
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$nin": [{"$regex": "DOG", "$options": ""}, {"$regex": "CAT", "$options": ""}, "dog"] } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : "cAt" } }
 { "_id" : { "$numberInt" : "7" }, "a" : [ { "b" : "CAT" } ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(8 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$nin": [{"$regex": "DOG", "$options": ""}, {"$regex": "CAT", "$options": ""}, "dog"] } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                 QUERY PLAN                                                                                                                                                                                                                                                                                                                  
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970032 collection WHERE (documentdb_api_catalog.bson_dollar_nin(document, '{ "a" : [ { "$regularExpression" : { "pattern" : "DOG", "options" : "" } }, { "$regularExpression" : { "pattern" : "CAT", "options" : "" } }, "dog" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@!*=) '{ "a" : [ { "$regularExpression" : { "pattern" : "DOG", "options" : "" } }, { "$regularExpression" : { "pattern" : "CAT", "options" : "" } }, "dog" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
-- $all: basic test with two values (case-insensitive match)
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$all": ["cAt", "DOG"] } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
                             document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
(1 row)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$all": ["cAt", "DOG"] } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970032 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cAt", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cAt", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(13 rows)

ROLLBACK;
BEGIN;
-- $all: single value (equivalent to $eq for arrays)
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$all": ["CAT"] } }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(7 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$all": ["CAT"] } }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970032 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
-- $all: on scalar field should return empty when multiple distinct values required
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "_id": 1, "a": { "$all": ["CAT", "DOG"] } }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
BEGIN;
-- $all: three values with case variations - tests AND semantics are preserved
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$all": ["CAT", "cat", "DOG"] } }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1} }');
                             document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
(1 row)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$all": ["CAT", "cat", "DOG"] } }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970032 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(13 rows)

ROLLBACK;
BEGIN;
-- $all: no matches (value not in any document)
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$all": ["ELEPHANT", "LION"] } }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
BEGIN;
-- $all: combined with $and on different field
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and": [{ "a": { "$all": ["CAT"] } }, { "b": { "$exists": true } }] }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1} }');
                                  document                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(2 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and": [{ "a": { "$all": ["CAT"] } }, { "b": { "$exists": true } }] }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970032 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#>=) '{ "b" : { "$minKey" : 1 }, "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@>=) '{ "b" : { "$minKey" : 1 }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(13 rows)

ROLLBACK;
BEGIN;
-- $all: combined with $or
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$or": [{ "a": { "$all": ["CAT", "DOG"] } }, { "_id": 1 }] }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1} }');
                             document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
(2 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$or": [{ "a": { "$all": ["CAT", "DOG"] } }, { "_id": 1 }] }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                                                                         QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                          
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970032 collection WHERE ((((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery)) OR (document OPERATOR(documentdb_api_catalog.#=) '{ "_id" : { "$numberInt" : "1" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery)) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (((collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)) OR (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "_id" : { "$numberInt" : "1" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(13 rows)

ROLLBACK;
BEGIN;
-- $all with regex
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$all": [{"$regex": "DOG", "$options": ""}, {"$regex": "CAT", "$options": ""}, "dog"] } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$all": [{"$regex": "DOG", "$options": ""}, {"$regex": "CAT", "$options": ""}, "dog"] } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                                                                                                                         QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                          
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970032 collection WHERE (documentdb_api_catalog.bson_dollar_regex(document, '{ "a" : { "$regularExpression" : { "pattern" : "DOG", "options" : "" } }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND documentdb_api_catalog.bson_dollar_regex(document, '{ "a" : { "$regularExpression" : { "pattern" : "CAT", "options" : "" } }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@~) '{ "a" : { "$regularExpression" : { "pattern" : "DOG", "options" : "" } }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@~) '{ "a" : { "$regularExpression" : { "pattern" : "CAT", "options" : "" } }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(13 rows)

ROLLBACK;
BEGIN;
-- $elemMatch
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$elemMatch": { "$eq": "CAT" } } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
                             document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
(1 row)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$elemMatch": { "$eq": "CAT" } } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                      QUERY PLAN                                                                                                                                                                                                                                                       
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970032 collection WHERE (documentdb_api_catalog.bson_dollar_elemmatch(document, '{ "a" : { "$eq" : "CAT" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@#?) '{ "a" : { "$eq" : "CAT" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
-- $elemMatch with range
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$elemMatch": { "$gte": "cat", "$lte": "dog" } } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
                             document                              
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
(1 row)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$elemMatch": { "$gte": "cat", "$lte": "dog" } } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970032 collection WHERE (documentdb_api_catalog.bson_dollar_elemmatch(document, '{ "a" : { "$gte" : "cat", "$lte" : "dog" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@#?) '{ "a" : { "$gte" : "cat", "$lte" : "dog" }, "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$or" : [{ "a": { "$lte": "cat" } }, { "a": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(11 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$or" : [{ "a": { "$lte": "cat" } }, { "a": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970032 collection WHERE (((document OPERATOR(documentdb_api_catalog.#<=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) OR (document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery)) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@<=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) OR (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(13 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "a": { "$gte": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 1 } }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "a": { "$gte": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 1 } }');
                                                                                                                                                                                                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Limit
   Output: remote_scan.document, remote_scan."?sort?"
   ->  Sort
         Output: remote_scan.document, remote_scan."?sort?"
         Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
         ->  Custom Scan (Citus Adaptive)
               Output: remote_scan.document, remote_scan."?sort?"
               Task Count: 8
               Tasks Shown: One of 8
               ->  Task
                     Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970032 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '10'::bigint
                     Node: host=localhost port=58070 dbname=regression
                     ->  Limit
                           Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                           ->  Sort
                                 Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                                 Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                                 ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                                       Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                                       Filter: ((collection.document OPERATOR(documentdb_api_catalog.@>=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(20 rows)

ROLLBACK;
-- aggregate: sharded
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(7 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970032 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$gt": "DOG" } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$gt": "DOG" } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970032 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>) '{ "a" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@>) '{ "a" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
-- $match followed by $project
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" } } }, { "$project": { "a": 1, "_id": 0 } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
             document              
---------------------------------------------------------------------
 { "a" : "Cat" }
 { "a" : "cat" }
 { "a" : [ "Cat", "cat", "dog" ] }
 { "a" : "cat" }
 { "a" : "cat" }
 { "a" : "cat" }
 { "a" : "cat" }
(7 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" } } }, { "$project": { "a": 1, "_id": 0 } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "_id" : { "$numberInt" : "0" } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970032 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                     Output: documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "_id" : { "$numberInt" : "0" } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text), documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
-- $match then $unwind
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "dog" } } }, { "$unwind": "$a" } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
                             document                             
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "6" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "6" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "6" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
(7 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "dog" } } }, { "$unwind": "$a" } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                QUERY PLAN                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT documentdb_api_catalog.bson_dollar_unwind(document, '$a'::text) AS document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970032 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  ProjectSet
                     Output: documentdb_api_catalog.bson_dollar_unwind(document, '$a'::text), documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                           Output: shard_key_value, object_id, document
                           Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(15 rows)

ROLLBACK;
BEGIN;
-- $match then $addFields
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "dog" } } },  { "$addFields": { "x": "DOG" } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
                                    document                                    
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog", "x" : "DOG" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog", "x" : "DOG" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ], "x" : "DOG" }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien", "x" : "DOG" }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman", "x" : "DOG" }
(5 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "dog" } } },  { "$addFields": { "x": "DOG" } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                                        QUERY PLAN                                                                                                                                                                                                                                                                                                                                                         
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT documentdb_api_internal.bson_dollar_add_fields(document, '{ "x" : "DOG" }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970032 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                     Output: documentdb_api_internal.bson_dollar_add_fields(document, '{ "x" : "DOG" }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text), documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
-- $sort after $match
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$in": ["cat", "dog"] } } }, { "$sort": { "_id": 1 } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(11 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$in": ["cat", "dog"] } } }, { "$sort": { "_id": 1 } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT worker_column_1 AS document, documentdb_api_internal.bson_orderby(worker_column_1, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM (SELECT agg_stage_2.document AS worker_column_1 FROM (SELECT collection.document FROM documentdb_data.documents_9701_970032 collection WHERE ((documentdb_api_catalog.bson_dollar_in(collection.document, '{ "a" : [ "cat", "dog" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_internal.##=) ANY (ARRAY['{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_api_internal.bsonindexbounds, '{ "a" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_api_internal.bsonindexbounds]))) AND documentdb_api_internal.bson_dollar_fullscan(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST) agg_stage_2) worker_subquery
               Node: host=localhost port=58070 dbname=regression
               ->  Subquery Scan on agg_stage_2
                     Output: agg_stage_2.document, documentdb_api_internal.bson_orderby(agg_stage_2.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     ->  Sort
                           Output: collection.document, (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                           Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                           ->  Seq Scan on documentdb_data.documents_9701_970032 collection
                                 Output: collection.document, documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                                 Filter: (collection.document OPERATOR(documentdb_api_catalog.@*=) '{ "a" : [ "cat", "dog" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(18 rows)

ROLLBACK;
BEGIN;
-- deleteOne
SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "a": { "$gte": "rabbit" } },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

SELECT documentdb_api.delete('db',
  '{ "delete": "coll_index_2",
     "deletes": [
       { "q": { "_id": 1, "a": { "$gte": "rabbit" } },
         "limit": 1,
         "collation": { "locale": "en", "strength": 1 }
       }
     ]
   }');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "a": { "$gte": "rabbit" } },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
BEGIN;
-- deleteMany
SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "$or": [{ "a": { "$in": ["CAT", "dog"] } }, { "a": { "$lte": "RABBIT" } }] },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(11 rows)

SELECT documentdb_api.delete('db',
  '{ "delete": "coll_index_2",
     "deletes": [
       { "q": { "a": { "$in": ["CAT", "dog"] } },
         "limit": 0,
         "collation": { "locale": "en", "strength": 1 }
       },
       { "q": { "a": { "$lte": "RABBIT" } },
         "limit": 0,
         "collation": { "locale": "en", "strength": 1 }
       }
     ]
   }');
                                         delete                                          
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""11"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "$or": [{ "a": { "$in": ["CAT", "dog"] } }, { "a": { "$lte": "RABBIT" } }] },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
-- unshard and drop indexes
SELECT documentdb_api.unshard_collection('{ "unshardCollection": "db.coll_index_2" }');
 unshard_collection 
---------------------------------------------------------------------
 
(1 row)

CALL documentdb_api.drop_indexes('db', '{ "dropIndexes": "coll_index_2", "index": ["*"]}');
                          retval                          
---------------------------------------------------------------------
 { "ok" : true, "nIndexesWas" : { "$numberLong" : "1" } }
(1 row)

-- ======== SECTION 4: Wildcard indexes (unsharded) ========
-- wildcard indexes
SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'db',
  '{
     "createIndexes": "coll_index_2",
     "indexes": [
       {
         "key": {"c.$**": 1}, "name": "index_2_c_wildcard",
         "collation" : {"locale" : "en", "strength" : 1 }
       }
     ]
   }',
   TRUE
);
ERROR:  Error in specification { "key" : { "c.$**" : 1 }, "name" : "index_2_c_wildcard", "collation" : { "locale" : "en", "strength" : 1 } }:createIndex.collation is not implemented yet
BEGIN;
-- $eq
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                    QUERY PLAN                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970044 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970044 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(14 rows)

ROLLBACK; 
BEGIN;
-- $eq
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$eq": "dog" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$eq": "dog" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                    QUERY PLAN                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970044 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "c" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970044 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "c" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(14 rows)

ROLLBACK;
BEGIN;
-- $lt
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$lt": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$lt": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                    QUERY PLAN                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970044 collection WHERE ((document OPERATOR(documentdb_api_catalog.#<) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970044 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@<) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(14 rows)

ROLLBACK;
BEGIN;
-- $gt
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$gt": "CAT" }, "a" : {"$lt" : "RABBIT"} }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength" : 1 } }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
(2 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$gt": "CAT" }, "a" : {"$lt" : "RABBIT"} }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength" : 1 } }');
                                                                                                                                                                                                                                                                                                                                                                      QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970044 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>) '{ "c" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#<) '{ "a" : "RABBIT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970044 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@>) '{ "c" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@<) '{ "a" : "RABBIT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(14 rows)

ROLLBACK;
BEGIN;
-- $gte
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$gte": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
(2 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$gte": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970044 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970044 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@>=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(14 rows)

ROLLBACK;
-- wildcard indexes: aggregation pipeline
BEGIN;
-- $match with $eq
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$eq": "cat" } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$eq": "cat" } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970044 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND ((shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970044 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(14 rows)

ROLLBACK;
BEGIN;
-- $match with $gt
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$gt": "DOG" } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
(2 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$gt": "DOG" } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970044 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>) '{ "c" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND ((shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970044 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@>) '{ "c" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(14 rows)

ROLLBACK;
BEGIN;
-- $match followed by $project
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$eq": "cat" } } }, { "$project": { "c": 1, "_id": 0 } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$eq": "cat" } } }, { "$project": { "a": 1, "_id": 0 } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                                                                                                                      QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                       
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "_id" : { "$numberInt" : "0" } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS document FROM documentdb_data.documents_9701_970044 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND ((shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: (documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "_id" : { "$numberInt" : "0" } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text)), (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970044 collection
                     Output: documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "_id" : { "$numberInt" : "0" } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text), documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(14 rows)

ROLLBACK;
BEGIN;
-- deleteOne
SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "c": { "$lte": "Dog" } },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

SELECT documentdb_api.delete('db',
  '{ "delete": "coll_index_2",
     "deletes": [
       { "q": { "_id": 1, "c": { "$lte": "Dog" } },
         "limit": 1,
         "collation": { "locale": "en", "strength": 1 }
       }
     ]
   }');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "c": { "$lte": "Dog" } },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
BEGIN;
-- deleteMany
SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "$or": [{ "c": { "$nin": ["ZEBRA", "ELEPHANT"] } }, { "c": { "$lt": "rabbit" } }] },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : "cAt" } }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "7" }, "a" : [ { "b" : "CAT" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(13 rows)

SELECT documentdb_api.delete('db',
  '{ "delete": "coll_index_2",
     "deletes": [
       { "q": { "c": { "$nin": ["ZEBRA", "ELEPHANT"] } },
         "limit": 0,
         "collation": { "locale": "en", "strength": 1 }
       },
       { "q": { "c": { "$lt": "rabbit" } },
         "limit": 0,
         "collation": { "locale": "en", "strength": 1 }
       }
     ]
   }');
                                         delete                                          
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""13"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "$or": [{ "c": { "$nin": ["ZEBRA", "ELEPHANT"] } }, { "c": { "$lt": "rabbit" } }] },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
-- ======== SECTION 5: Wildcard indexes (sharded) ========
-- wildcard indexes: sharded collection
SELECT documentdb_api.shard_collection('db', 'coll_index_2', '{ "_id": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

BEGIN;
-- $eq
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970048 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970048 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK; 
BEGIN;
-- $eq
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$eq": "dog" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$eq": "dog" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970048 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "c" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970048 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "c" : "dog", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
-- $lt
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$lt": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$lt": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970048 collection WHERE ((document OPERATOR(documentdb_api_catalog.#<) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970048 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@<) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
-- $gt
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$gt": "CAT" }, "a" : {"$lt" : "RABBIT"} }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength" : 1 } }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
(2 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$gt": "CAT" }, "a" : {"$lt" : "RABBIT"} }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength" : 1 } }');
                                                                                                                                                                                                                                                                                                                QUERY PLAN                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970048 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>) '{ "c" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#<) '{ "a" : "RABBIT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970048 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@>) '{ "c" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@<) '{ "a" : "RABBIT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(13 rows)

ROLLBACK;
BEGIN;
-- $gte
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$gte": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
(2 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$gte": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970048 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970048 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@>=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
-- wildcard indexes: aggregation pipeline
BEGIN;
-- $match with $eq
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$eq": "cat" } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$eq": "cat" } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970048 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970048 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
-- $match with $gt
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$gt": "DOG" } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
(2 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$gt": "DOG" } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970048 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>) '{ "c" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970048 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@>) '{ "c" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
-- $match followed by $project
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$eq": "cat" } } }, { "$project": { "c": 1, "_id": 0 } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$eq": "cat" } } }, { "$project": { "a": 1, "_id": 0 } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "_id" : { "$numberInt" : "0" } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970048 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970048 collection
                     Output: documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "_id" : { "$numberInt" : "0" } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text), documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
-- deleteOne
SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "c": { "$lte": "Dog" } },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

SELECT documentdb_api.delete('db',
  '{ "delete": "coll_index_2",
     "deletes": [
       { "q": { "_id": 1, "c": { "$lte": "Dog" } },
         "limit": 1,
         "collation": { "locale": "en", "strength": 1 }
       }
     ]
   }');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "c": { "$lte": "Dog" } },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
BEGIN;
-- deleteMany
SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "$or": [{ "c": { "$nin": ["ZEBRA", "ELEPHANT"] } }, { "c": { "$lt": "rabbit" } }] },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : "cAt" } }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "7" }, "a" : [ { "b" : "CAT" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(13 rows)

SELECT documentdb_api.delete('db',
  '{ "delete": "coll_index_2",
     "deletes": [
       { "q": { "c": { "$nin": ["ZEBRA", "ELEPHANT"] } },
         "limit": 0,
         "collation": { "locale": "en", "strength": 1 }
       },
       { "q": { "c": { "$lt": "rabbit" } },
         "limit": 0,
         "collation": { "locale": "en", "strength": 1 }
       }
     ]
   }');
                                         delete                                          
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""13"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "$or": [{ "c": { "$nin": ["ZEBRA", "ELEPHANT"] } }, { "c": { "$lt": "rabbit" } }] },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
-- unshard and drop indexes
SELECT documentdb_api.unshard_collection('{ "unshardCollection": "db.coll_index_2" }');
 unshard_collection 
---------------------------------------------------------------------
 
(1 row)

CALL documentdb_api.drop_indexes('db', '{ "dropIndexes": "coll_index_2", "index": ["*"]}');
                          retval                          
---------------------------------------------------------------------
 { "ok" : true, "nIndexesWas" : { "$numberLong" : "1" } }
(1 row)

-- ======== SECTION 6: Multiple indexes (unsharded) ========
-- multiple indexes
-- index_2_a is case-sensitive, index_2_a_b is case-insensitive, index_2_wildcard is case-insensitive wildcard index
SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'db',
  '{
     "createIndexes": "coll_index_2",
     "indexes": [
        {
         "key": {"a": 1}, "name": "index_2_a",
         "collation" : {"locale" : "en", "strength" : 3}
        },
        {
        "key": {"a": 1, "b": -1}, "name": "index_2_a_b",
        "collation" : {"locale" : "en", "strength" : 1}
        },
        {
        "key": {"c.$**": 1}, "name": "index_2_wildcard",
        "collation" : {"locale" : "en", "strength" : 2}
        }
     ]
   }',
   TRUE
);
ERROR:  Error in specification { "key" : { "a" : 1 }, "name" : "index_2_a", "collation" : { "locale" : "en", "strength" : 3 } }:createIndex.collation is not implemented yet
BEGIN;
-- index_2_a is used
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "a": { "$gte": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 3 } }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "a": { "$gte": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 3 } }');
                                                                                                                                                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970060 collection WHERE (((document OPERATOR(documentdb_api_catalog.#>=) '{ "a" : "cat", "collation" : "en-u-ks-level3" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "b" : "DOG", "collation" : "en-u-ks-level3" }'::documentdb_core.bsonquery)) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level3'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '10'::bigint
         Node: host=localhost port=58070 dbname=regression
         ->  Limit
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level3'::text))
               ->  Sort
                     Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level3'::text))
                     Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level3'::text)) USING <<< NULLS FIRST
                     ->  Index Scan using _id_ on documentdb_data.documents_9701_970060 collection
                           Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level3'::text)
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
                           Filter: ((collection.document OPERATOR(documentdb_api_catalog.@>=) '{ "a" : "cat", "collation" : "en-u-ks-level3" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "b" : "DOG", "collation" : "en-u-ks-level3" }'::documentdb_core.bson))
(16 rows)

ROLLBACK;
BEGIN;
-- index_2_a_b used
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "a": { "$gte": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 1 } }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "a": { "$gte": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 1 } }');
                                                                                                                                                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970060 collection WHERE (((document OPERATOR(documentdb_api_catalog.#>=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery)) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '10'::bigint
         Node: host=localhost port=58070 dbname=regression
         ->  Limit
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               ->  Sort
                     Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                     Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                     ->  Index Scan using _id_ on documentdb_data.documents_9701_970060 collection
                           Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
                           Filter: ((collection.document OPERATOR(documentdb_api_catalog.@>=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(16 rows)

ROLLBACK;
BEGIN;
-- index_2_a_b used
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "a": { "$gte": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 1 } }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "a": { "$gte": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 1 } }');
                                                                                                                                                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970060 collection WHERE (((document OPERATOR(documentdb_api_catalog.#>=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery)) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '10'::bigint
         Node: host=localhost port=58070 dbname=regression
         ->  Limit
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               ->  Sort
                     Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                     Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                     ->  Index Scan using _id_ on documentdb_data.documents_9701_970060 collection
                           Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
                           Filter: ((collection.document OPERATOR(documentdb_api_catalog.@>=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(16 rows)

ROLLBACK;
BEGIN;
-- index_2_wildcard used
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "b": { "$gte": "cat" } }, { "c.d": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 2 } }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "b": { "$gte": "cat" } }, { "c.d": { "$eq": "kraMAn" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 2 } }');
                                                                                                                                                                                                                                                                                                                                                                                  QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                  
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970060 collection WHERE (((document OPERATOR(documentdb_api_catalog.#>=) '{ "b" : "cat", "collation" : "en-u-ks-level2" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "c.d" : "kraMAn", "collation" : "en-u-ks-level2" }'::documentdb_core.bsonquery)) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level2'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '10'::bigint
         Node: host=localhost port=58070 dbname=regression
         ->  Limit
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level2'::text))
               ->  Sort
                     Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level2'::text))
                     Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level2'::text)) USING <<< NULLS FIRST
                     ->  Index Scan using _id_ on documentdb_data.documents_9701_970060 collection
                           Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level2'::text)
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
                           Filter: ((collection.document OPERATOR(documentdb_api_catalog.@>=) '{ "b" : "cat", "collation" : "en-u-ks-level2" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "c.d" : "kraMAn", "collation" : "en-u-ks-level2" }'::documentdb_core.bson))
(16 rows)

ROLLBACK;
BEGIN;
-- $match with $and and $or
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "a": { "$gte": "cat" } }, { "c.d": { "$eq": "okra" } }, { "$or" : [{ "b": { "$eq": "DOG" } }, { "b": { "$eq": "cat" } }] }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 1 } }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "a": { "$gte": "cat" } }, { "c.d": { "$eq": "okra" } }, { "$or" : [{ "b": { "$eq": "DOG" } }, { "b": { "$eq": "cat" } }] }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 1 } }');
                                                                                                                                                                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970060 collection WHERE (((document OPERATOR(documentdb_api_catalog.#>=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "c.d" : "okra", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_catalog.bson_dollar_in(document, '{ "b" : [ "DOG", "cat" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson)) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '10'::bigint
         Node: host=localhost port=58070 dbname=regression
         ->  Limit
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               ->  Sort
                     Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                     Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                     ->  Index Scan using _id_ on documentdb_data.documents_9701_970060 collection
                           Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                           Index Cond: (collection.shard_key_value = '9701'::bigint)
                           Filter: ((collection.document OPERATOR(documentdb_api_catalog.@>=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "c.d" : "okra", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@*=) '{ "b" : [ "DOG", "cat" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(16 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" }, "b": "DOG" } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" }, "b": "DOG" } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                                                                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970060 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND ((shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970060 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(14 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$eq": "KRAMAN" }, "b": "DOG" } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" }, "b": "DOG" } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                                                                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970060 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND ((shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970060 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(14 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$lte": "cat" }, "b": "DOG" } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 2}  }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$lte": "cat" }, "b": "DOG" } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 2}  }');
                                                                                                                                                                                                                                                                                                                                                                      QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970060 collection WHERE ((document OPERATOR(documentdb_api_catalog.#<=) '{ "a" : "cat", "collation" : "en-u-ks-level2" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "b" : "DOG", "collation" : "en-u-ks-level2" }'::documentdb_core.bsonquery) AND ((shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level2'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level2'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level2'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970060 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level2'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@<=) '{ "a" : "cat", "collation" : "en-u-ks-level2" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "b" : "DOG", "collation" : "en-u-ks-level2" }'::documentdb_core.bson))
(14 rows)

ROLLBACK;
-- ======== SECTION 7: Multiple indexes (sharded) ========
SELECT documentdb_api.shard_collection('db', 'coll_index_2', '{ "_id": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

BEGIN;
-- index_2_a is used
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "a": { "$gte": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 3 } }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "a": { "$gte": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 3 } }');
                                                                                                                                                                                                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Limit
   Output: remote_scan.document, remote_scan."?sort?"
   ->  Sort
         Output: remote_scan.document, remote_scan."?sort?"
         Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
         ->  Custom Scan (Citus Adaptive)
               Output: remote_scan.document, remote_scan."?sort?"
               Task Count: 8
               Tasks Shown: One of 8
               ->  Task
                     Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level3'::text) AS "?sort?" FROM documentdb_data.documents_9701_970064 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>=) '{ "a" : "cat", "collation" : "en-u-ks-level3" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "b" : "DOG", "collation" : "en-u-ks-level3" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level3'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '10'::bigint
                     Node: host=localhost port=58070 dbname=regression
                     ->  Limit
                           Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level3'::text))
                           ->  Sort
                                 Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level3'::text))
                                 Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level3'::text)) USING <<< NULLS FIRST
                                 ->  Seq Scan on documentdb_data.documents_9701_970064 collection
                                       Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level3'::text)
                                       Filter: ((collection.document OPERATOR(documentdb_api_catalog.@>=) '{ "a" : "cat", "collation" : "en-u-ks-level3" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "b" : "DOG", "collation" : "en-u-ks-level3" }'::documentdb_core.bson))
(20 rows)

ROLLBACK;
BEGIN;
-- index_2_a_b used
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "a": { "$gte": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 1 } }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "a": { "$gte": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 1 } }');
                                                                                                                                                                                                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Limit
   Output: remote_scan.document, remote_scan."?sort?"
   ->  Sort
         Output: remote_scan.document, remote_scan."?sort?"
         Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
         ->  Custom Scan (Citus Adaptive)
               Output: remote_scan.document, remote_scan."?sort?"
               Task Count: 8
               Tasks Shown: One of 8
               ->  Task
                     Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970064 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '10'::bigint
                     Node: host=localhost port=58070 dbname=regression
                     ->  Limit
                           Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                           ->  Sort
                                 Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                                 Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                                 ->  Seq Scan on documentdb_data.documents_9701_970064 collection
                                       Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                                       Filter: ((collection.document OPERATOR(documentdb_api_catalog.@>=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(20 rows)

ROLLBACK;
BEGIN;
-- index_2_a_b used
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "a": { "$gte": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 1 } }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "a": { "$gte": "cat" } }, { "b": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 1 } }');
                                                                                                                                                                                                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Limit
   Output: remote_scan.document, remote_scan."?sort?"
   ->  Sort
         Output: remote_scan.document, remote_scan."?sort?"
         Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
         ->  Custom Scan (Citus Adaptive)
               Output: remote_scan.document, remote_scan."?sort?"
               Task Count: 8
               Tasks Shown: One of 8
               ->  Task
                     Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970064 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '10'::bigint
                     Node: host=localhost port=58070 dbname=regression
                     ->  Limit
                           Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                           ->  Sort
                                 Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                                 Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                                 ->  Seq Scan on documentdb_data.documents_9701_970064 collection
                                       Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                                       Filter: ((collection.document OPERATOR(documentdb_api_catalog.@>=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(20 rows)

ROLLBACK;
BEGIN;
-- index_2_wildcard used
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "b": { "$gte": "cat" } }, { "c.d": { "$eq": "DOG" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 2 } }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "b": { "$gte": "cat" } }, { "c.d": { "$eq": "kraMAn" } }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 2 } }');
                                                                                                                                                                                                                                                                                                                                                                                                                                 QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                 
---------------------------------------------------------------------
 Limit
   Output: remote_scan.document, remote_scan."?sort?"
   ->  Sort
         Output: remote_scan.document, remote_scan."?sort?"
         Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
         ->  Custom Scan (Citus Adaptive)
               Output: remote_scan.document, remote_scan."?sort?"
               Task Count: 8
               Tasks Shown: One of 8
               ->  Task
                     Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level2'::text) AS "?sort?" FROM documentdb_data.documents_9701_970064 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>=) '{ "b" : "cat", "collation" : "en-u-ks-level2" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "c.d" : "kraMAn", "collation" : "en-u-ks-level2" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level2'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '10'::bigint
                     Node: host=localhost port=58070 dbname=regression
                     ->  Limit
                           Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level2'::text))
                           ->  Sort
                                 Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level2'::text))
                                 Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level2'::text)) USING <<< NULLS FIRST
                                 ->  Seq Scan on documentdb_data.documents_9701_970064 collection
                                       Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level2'::text)
                                       Filter: ((collection.document OPERATOR(documentdb_api_catalog.@>=) '{ "b" : "cat", "collation" : "en-u-ks-level2" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "c.d" : "kraMAn", "collation" : "en-u-ks-level2" }'::documentdb_core.bson))
(20 rows)

ROLLBACK;
BEGIN;
-- $match with $and and $or
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "a": { "$gte": "cat" } }, { "c.d": { "$eq": "okra" } }, { "$or" : [{ "b": { "$eq": "DOG" } }, { "b": { "$eq": "cat" } }] }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 1 } }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "$and" : [{ "a": { "$gte": "cat" } }, { "c.d": { "$eq": "okra" } }, { "$or" : [{ "b": { "$eq": "DOG" } }, { "b": { "$eq": "cat" } }] }] }, "sort": { "_id": 1 }, "skip": 0, "limit": 10, "collation": { "locale": "en", "strength" : 1 } }');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
---------------------------------------------------------------------
 Limit
   Output: remote_scan.document, remote_scan."?sort?"
   ->  Sort
         Output: remote_scan.document, remote_scan."?sort?"
         Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
         ->  Custom Scan (Citus Adaptive)
               Output: remote_scan.document, remote_scan."?sort?"
               Task Count: 8
               Tasks Shown: One of 8
               ->  Task
                     Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970064 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "c.d" : "okra", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_catalog.bson_dollar_in(document, '{ "b" : [ "DOG", "cat" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST LIMIT '10'::bigint
                     Node: host=localhost port=58070 dbname=regression
                     ->  Limit
                           Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                           ->  Sort
                                 Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
                                 Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
                                 ->  Seq Scan on documentdb_data.documents_9701_970064 collection
                                       Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                                       Filter: ((collection.document OPERATOR(documentdb_api_catalog.@>=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "c.d" : "okra", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@*=) '{ "b" : [ "DOG", "cat" ], "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(20 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" }, "b": "DOG" } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" }, "b": "DOG" } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                                                                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970064 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970064 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(13 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$eq": "KRAMAN" }, "b": "DOG" } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" }, "b": "DOG" } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                                                                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970064 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970064 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(13 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$lte": "cat" }, "b": "DOG" } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 2}  }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$lte": "cat" }, "b": "DOG" } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 2}  }');
                                                                                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level2'::text) AS "?sort?" FROM documentdb_data.documents_9701_970064 collection WHERE ((document OPERATOR(documentdb_api_catalog.#<=) '{ "a" : "cat", "collation" : "en-u-ks-level2" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#=) '{ "b" : "DOG", "collation" : "en-u-ks-level2" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970064 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level2'::text)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@<=) '{ "a" : "cat", "collation" : "en-u-ks-level2" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "b" : "DOG", "collation" : "en-u-ks-level2" }'::documentdb_core.bson))
(13 rows)

ROLLBACK;
BEGIN;
-- deleteOne
SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "a": { "$ne": "rabbit" }, "b": { "$in": ["Dog", "CAT"] } },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

SELECT documentdb_api.delete('db',
  '{ "delete": "coll_index_2",
     "deletes": [
       { "q": { "_id": 1, "a": { "$ne": "rabbit" }, "b": { "$in": ["Dog", "CAT"] } },
         "limit": 1,
         "collation": { "locale": "en", "strength": 1 }
       }
     ]
   }');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "a": { "$ne": "rabbit" }, "b": { "$in": ["Dog", "CAT"] } },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
BEGIN;
-- deleteMany
SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "$or": [{ "a": { "$gt": "Cat" }, "b": { "$lte": "DOG" } }, { "a": { "$lt": "DOG" } }] },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(8 rows)

SELECT documentdb_api.delete('db',
  '{ "delete": "coll_index_2",
     "deletes": [
       { "q": { "a": { "$gt": "Cat" }, "b": { "$lte": "DOG" } },
         "limit": 0,
         "collation": { "locale": "en", "strength": 1 }
       },
       { "q": { "a": { "$lt": "DOG" } },
         "limit": 0,
         "collation": { "locale": "en", "strength": 1 }
       }
     ]
   }');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""8"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "$or": [{ "a": { "$gt": "Cat" }, "b": { "$lte": "DOG" } }, { "a": { "$lt": "DOG" } }] },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
-- unshard and drop indexes
SELECT documentdb_api.unshard_collection('{ "unshardCollection": "db.coll_index_2" }');
 unshard_collection 
---------------------------------------------------------------------
 
(1 row)

CALL documentdb_api.drop_indexes('db', '{"dropIndexes": "coll_index_2", "index": ["*"]}');
                          retval                          
---------------------------------------------------------------------
 { "ok" : true, "nIndexesWas" : { "$numberLong" : "1" } }
(1 row)

-- ======== SECTION 10: Wildcard with projection - exclusion (unsharded) ========
-- wildcard with projection: exclusion
SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'db',
  '{
     "createIndexes": "coll_index_2",
     "indexes": [
       {
         "key": {"$**": 1}, "name": "index_2_wildcard_projection_exclusion",
         "wildcardProjection": { "a": 0 },
         "collation" : {"locale" : "en", "strength" : 1 }
       }
     ]
   }',
   TRUE
);
ERROR:  Error in specification { "key" : { "$**" : 1 }, "name" : "index_2_wildcard_projection_exclusion", "wildcardProjection" : { "a" : 0 }, "collation" : { "locale" : "en", "strength" : 1 } }:createIndex.collation is not implemented yet
-- wildcard with projection exclusion: find
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(7 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                    QUERY PLAN                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970076 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970076 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(14 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "b": { "$eq": "chIen" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                  document                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
(2 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "b": { "$eq": "chIen" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970076 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "b" : "chIen", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970076 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "b" : "chIen", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(14 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$lt": "OKrA" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
(2 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$lt": "OKrA" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970076 collection WHERE ((document OPERATOR(documentdb_api_catalog.#<) '{ "c" : "OKrA", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970076 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@<) '{ "c" : "OKrA", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(14 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$gte": "CAT" }, "b" : {"$lte" : "cHaT"} }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength" : 1 } }');
                                  document                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
(1 row)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$gte": "CAT" }, "b" : {"$lte" : "cHaT"} }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength" : 1 } }');
                                                                                                                                                                                                                                                                                                                                                                      QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970076 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#<=) '{ "b" : "cHaT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970076 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@>=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@<=) '{ "b" : "cHaT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(14 rows)

ROLLBACK;
-- wildcard with projection exclusion: aggregation pipeline
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(7 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970076 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND ((shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970076 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(14 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "b": { "$gt": "DOG" } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "b": { "$gt": "DOG" } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970076 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND ((shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970076 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@>) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(14 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$eq": "cat" } } }, { "$project": { "a": 1, "_id": 0 } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$eq": "cat" } } }, { "$project": { "a": 1, "_id": 0 } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                                                                                                                      QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                       
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "_id" : { "$numberInt" : "0" } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS document FROM documentdb_data.documents_9701_970076 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND ((shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: (documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "_id" : { "$numberInt" : "0" } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text)), (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970076 collection
                     Output: documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "_id" : { "$numberInt" : "0" } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text), documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(14 rows)

ROLLBACK;
BEGIN;
-- deleteOne
SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "a": { "$ne": "zebra" }, "b": { "$gte": "cat" } },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
                                  document                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
(2 rows)

SELECT documentdb_api.delete('db',
  '{ "delete": "coll_index_2",
     "deletes": [
       { "q": { "_id": 1, "a": { "$ne": "zebra" }, "b": { "$gte": "cat" } },
         "limit": 1,
         "collation": { "locale": "en", "strength": 1 }
       }
     ]
   }');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "a": { "$ne": "zebra" }, "b": { "$gte": "cat" } },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
                                  document                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
(2 rows)

ROLLBACK;
BEGIN;
-- deleteMany
SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "$or": [{ "a": { "$in": ["cat", "DOG"] } }, { "b": { "$gt": "CAT" } }] },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(11 rows)

SELECT documentdb_api.delete('db',
  '{ "delete": "coll_index_2",
     "deletes": [
       { "q": { "a": { "$in": ["cat", "DOG"] } },
         "limit": 0,
         "collation": { "locale": "en", "strength": 1 }
       },
       { "q": { "b": { "$gt": "CAT" } },
         "limit": 0,
         "collation": { "locale": "en", "strength": 1 }
       }
     ]
   }');
                                         delete                                          
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""11"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "$or": [{ "a": { "$in": ["cat", "DOG"] } }, { "b": { "$gt": "CAT" } }] },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
CALL documentdb_api.drop_indexes('db', '{ "dropIndexes": "coll_index_2", "index": ["*"]}');
                          retval                          
---------------------------------------------------------------------
 { "ok" : true, "nIndexesWas" : { "$numberLong" : "1" } }
(1 row)

-- ======== SECTION 11: Wildcard with projection - exclusion (sharded) ========
SELECT documentdb_api.shard_collection('db', 'coll_index_2', '{ "_id": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

-- wildcard with projection exclusion: find
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(7 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970080 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970080 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "b": { "$eq": "chIen" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                  document                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
(2 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "b": { "$eq": "chIen" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970080 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "b" : "chIen", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970080 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "b" : "chIen", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$lt": "OKrA" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
(2 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$lt": "OKrA" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970080 collection WHERE ((document OPERATOR(documentdb_api_catalog.#<) '{ "c" : "OKrA", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970080 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@<) '{ "c" : "OKrA", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$gte": "CAT" }, "b" : {"$lte" : "cHaT"} }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength" : 1 } }');
                                  document                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
(1 row)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$gte": "CAT" }, "b" : {"$lte" : "cHaT"} }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength" : 1 } }');
                                                                                                                                                                                                                                                                                                                QUERY PLAN                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970080 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#<=) '{ "b" : "cHaT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970080 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@>=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@<=) '{ "b" : "cHaT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(13 rows)

ROLLBACK;
-- wildcard with projection exclusion: aggregation pipeline
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(7 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970080 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970080 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "b": { "$gt": "DOG" } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "b": { "$gt": "DOG" } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970080 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970080 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@>) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$eq": "cat" } } }, { "$project": { "a": 1, "_id": 0 } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$eq": "cat" } } }, { "$project": { "a": 1, "_id": 0 } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "_id" : { "$numberInt" : "0" } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970080 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970080 collection
                     Output: documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "_id" : { "$numberInt" : "0" } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text), documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
-- deleteOne
SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "c": { "$eq": "cat" } },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

SELECT documentdb_api.delete('db',
  '{ "delete": "coll_index_2",
     "deletes": [
       { "q": { "_id": 1, "c": { "$eq": "cat" } },
         "limit": 1,
         "collation": { "locale": "en", "strength": 1 }
       }
     ]
   }');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "c": { "$eq": "cat" } },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
BEGIN;
-- deleteMany
SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "$or": [{ "c": { "$gte": "dog" } }, { "b": { "$lte": "CAT" } }] },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
(2 rows)

SELECT documentdb_api.delete('db',
  '{ "delete": "coll_index_2",
     "deletes": [
       { "q": { "c": { "$gte": "dog" } },
         "limit": 0,
         "collation": { "locale": "en", "strength": 1 }
       },
       { "q": { "b": { "$lte": "CAT" } },
         "limit": 0,
         "collation": { "locale": "en", "strength": 1 }
       }
     ]
   }');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""2"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "$or": [{ "c": { "$gte": "dog" } }, { "b": { "$lte": "CAT" } }] },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$eq": "cat" } } }, { "$project": { "a": 1, "_id": 0 } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$eq": "cat" } } }, { "$project": { "a": 1, "_id": 0 } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "_id" : { "$numberInt" : "0" } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970080 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970080 collection
                     Output: documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "_id" : { "$numberInt" : "0" } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text), documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
-- deleteOne
SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "c": { "$lt": "rabbit" } },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
(2 rows)

SELECT documentdb_api.delete('db',
  '{ "delete": "coll_index_2",
     "deletes": [
       { "q": { "_id": 1, "c": { "$lt": "rabbit" } },
         "limit": 1,
         "collation": { "locale": "en", "strength": 1 }
       }
     ]
   }');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "c": { "$lt": "rabbit" } },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
(2 rows)

ROLLBACK;
BEGIN;
-- deleteMany
SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "$or": [{ "a": { "$gte": "CAT" } }, { "b": { "$in": ["dog", "CHAT"] } }] },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(11 rows)

SELECT documentdb_api.delete('db',
  '{ "delete": "coll_index_2",
     "deletes": [
       { "q": { "a": { "$gte": "CAT" } },
         "limit": 0,
         "collation": { "locale": "en", "strength": 1 }
       },
       { "q": { "b": { "$in": ["dog", "CHAT"] } },
         "limit": 0,
         "collation": { "locale": "en", "strength": 1 }
       }
     ]
   }');
                                         delete                                          
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""11"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "$or": [{ "a": { "$gte": "CAT" } }, { "b": { "$in": ["dog", "CHAT"] } }] },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
SELECT documentdb_api.unshard_collection('{ "unshardCollection": "db.coll_index_2" }');
 unshard_collection 
---------------------------------------------------------------------
 
(1 row)

CALL documentdb_api.drop_indexes('db', '{ "dropIndexes": "coll_index_2", "index": ["*"]}');
                          retval                          
---------------------------------------------------------------------
 { "ok" : true, "nIndexesWas" : { "$numberLong" : "1" } }
(1 row)

-- ======== SECTION 12: Wildcard with projection - inclusion (unsharded) ========
-- wildcardProjection: inclusion
SELECT documentdb_api_internal.create_indexes_non_concurrently(
  'db',
  '{
     "createIndexes": "coll_index_2",
     "indexes": [
       {
         "key": {"$**": 1}, "name": "index_2_wildcard_projection_inclusion",
         "wildcardProjection": { "b": 1, "c": 1 },
         "collation" : {"locale" : "en", "strength" : 1 }
       }
     ]
   }',
   TRUE
);
ERROR:  Error in specification { "key" : { "$**" : 1 }, "name" : "index_2_wildcard_projection_inclusion", "wildcardProjection" : { "b" : 1, "c" : 1 }, "collation" : { "locale" : "en", "strength" : 1 } }:createIndex.collation is not implemented yet
-- wildcard with projection: find
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(7 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                    QUERY PLAN                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970092 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970092 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(14 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "b": { "$eq": "chIen" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                  document                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
(2 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "b": { "$eq": "chIen" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970092 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "b" : "chIen", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970092 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "b" : "chIen", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(14 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$lt": "OKrA" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
(2 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$lt": "OKrA" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                     
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970092 collection WHERE ((document OPERATOR(documentdb_api_catalog.#<) '{ "c" : "OKrA", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970092 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@<) '{ "c" : "OKrA", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(14 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$gte": "CAT" }, "b" : {"$lte" : "cHaT"} }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength" : 1 } }');
                                  document                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
(1 row)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$gte": "CAT" }, "b" : {"$lte" : "cHaT"} }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength" : 1 } }');
                                                                                                                                                                                                                                                                                                                                                                      QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970092 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#<=) '{ "b" : "cHaT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson)) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970092 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@>=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@<=) '{ "b" : "cHaT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(14 rows)

ROLLBACK;
-- wildcard with projection: aggregation pipeline
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(7 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970092 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND ((shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970092 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(14 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "b": { "$gt": "DOG" } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "b": { "$gt": "DOG" } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                      
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT document FROM documentdb_data.documents_9701_970092 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND ((shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: document, (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970092 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@>) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(14 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$eq": "cat" } } }, { "$project": { "a": 1, "_id": 0 } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$eq": "cat" } } }, { "$project": { "a": 1, "_id": 0 } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                                                                                                                      QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                       
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "_id" : { "$numberInt" : "0" } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS document FROM documentdb_data.documents_9701_970092 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND ((shard_key_value OPERATOR(pg_catalog.=) '9701'::bigint) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))) ORDER BY (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING OPERATOR(documentdb_api_internal.<<<) NULLS FIRST
         Node: host=localhost port=58070 dbname=regression
         ->  Sort
               Output: (documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "_id" : { "$numberInt" : "0" } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text)), (documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text))
               Sort Key: (documentdb_api_internal.bson_orderby(collection.document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)) USING <<< NULLS FIRST
               ->  Index Scan using _id_ on documentdb_data.documents_9701_970092 collection
                     Output: documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "_id" : { "$numberInt" : "0" } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text), documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Index Cond: (collection.shard_key_value = '9701'::bigint)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(14 rows)

ROLLBACK;
BEGIN;
-- deleteOne
SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "c": { "$ne": "zebra" } },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : "cAt" } }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "7" }, "a" : [ { "b" : "CAT" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(13 rows)

SELECT documentdb_api.delete('db',
  '{ "delete": "coll_index_2",
     "deletes": [
       { "q": { "_id": 1, "c": { "$ne": "zebra" } },
         "limit": 1,
         "collation": { "locale": "en", "strength": 1 }
       }
     ]
   }');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""1"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "c": { "$ne": "zebra" } },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "5" }, "a" : { "b" : "cAt" } }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "7" }, "a" : [ { "b" : "CAT" } ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(12 rows)

ROLLBACK;
BEGIN;
-- deleteMany
SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "$or": [{ "a": { "$gt": "CAT" } }, { "b": { "$lte": "dog" } }] },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
                                  document                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
(6 rows)

SELECT documentdb_api.delete('db',
  '{ "delete": "coll_index_2",
     "deletes": [
       { "q": { "a": { "$gt": "CAT" } },
         "limit": 0,
         "collation": { "locale": "en", "strength": 1 }
       },
       { "q": { "b": { "$lte": "dog" } },
         "limit": 0,
         "collation": { "locale": "en", "strength": 1 }
       }
     ]
   }');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""6"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "$or": [{ "a": { "$gt": "CAT" } }, { "b": { "$lte": "dog" } }] },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
CALL documentdb_api.drop_indexes('db', '{ "dropIndexes": "coll_index_2", "index": ["*"]}');
                          retval                          
---------------------------------------------------------------------
 { "ok" : true, "nIndexesWas" : { "$numberLong" : "1" } }
(1 row)

-- ======== SECTION 13: Wildcard with projection - inclusion (sharded) ========
SELECT documentdb_api.shard_collection('db', 'coll_index_2', '{ "_id": "hashed" }', false);
 shard_collection 
---------------------------------------------------------------------
 
(1 row)

-- wildcard with projection: find
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(7 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$eq": "cat" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970096 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970096 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "b": { "$eq": "chIen" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                  document                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
(2 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "b": { "$eq": "chIen" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970096 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "b" : "chIen", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970096 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "b" : "chIen", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$lt": "OKrA" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
(2 rows)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "c": { "$lt": "OKrA" } }, "sort": { "_id": 1 }, "skip": 0, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970096 collection WHERE ((document OPERATOR(documentdb_api_catalog.#<) '{ "c" : "OKrA", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970096 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@<) '{ "c" : "OKrA", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$gte": "CAT" }, "b" : {"$lte" : "cHaT"} }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength" : 1 } }');
                                  document                                   
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
(1 row)

EXPLAIN(VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_find('db', '{ "find": "coll_index_2", "filter": { "a": { "$gte": "CAT" }, "b" : {"$lte" : "cHaT"} }, "sort": { "_id": 1 }, "collation": { "locale": "en", "strength" : 1 } }');
                                                                                                                                                                                                                                                                                                                QUERY PLAN                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970096 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND (document OPERATOR(documentdb_api_catalog.#<=) '{ "b" : "cHaT", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970096 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@>=) '{ "a" : "CAT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson) AND (collection.document OPERATOR(documentdb_api_catalog.@<=) '{ "b" : "cHaT", "collation" : "en-u-ks-level1" }'::documentdb_core.bson))
(13 rows)

ROLLBACK;
-- wildcard with projection: aggregation pipeline
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(7 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "a": { "$eq": "cat" } } } ], "cursor": {}, "collation": { "locale": "en", "strength" : 1}  }');
                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970096 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970096 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "a" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "b": { "$gt": "DOG" } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "b": { "$gt": "DOG" } } }], "cursor": {}, "collation": { "locale": "en", "strength" : 1} }');
                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                               
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970096 collection WHERE ((document OPERATOR(documentdb_api_catalog.#>) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970096 collection
                     Output: document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@>) '{ "b" : "DOG", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
SET LOCAL enable_seqscan TO OFF;
SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$eq": "cat" } } }, { "$project": { "a": 1, "_id": 0 } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
 document 
---------------------------------------------------------------------
(0 rows)

EXPLAIN (VERBOSE ON, COSTS OFF) SELECT document FROM bson_aggregation_pipeline('db', '{ "aggregate": "coll_index_2", "pipeline": [ { "$sort": { "_id": 1 } }, { "$match": { "c": { "$eq": "cat" } } }, { "$project": { "a": 1, "_id": 0 } } ], "cursor": {}, "collation": { "locale": "en", "strength": 1} }');
                                                                                                                                                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------
 Sort
   Output: remote_scan.document, remote_scan."?sort?"
   Sort Key: remote_scan."?sort?" USING <<< NULLS FIRST
   ->  Custom Scan (Citus Adaptive)
         Output: remote_scan.document, remote_scan."?sort?"
         Task Count: 8
         Tasks Shown: One of 8
         ->  Task
               Query: SELECT documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "_id" : { "$numberInt" : "0" } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS document, documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text) AS "?sort?" FROM documentdb_data.documents_9701_970096 collection WHERE ((document OPERATOR(documentdb_api_catalog.#=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bsonquery) AND documentdb_api_internal.bson_dollar_fullscan(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson))
               Node: host=localhost port=58070 dbname=regression
               ->  Seq Scan on documentdb_data.documents_9701_970096 collection
                     Output: documentdb_api_internal.bson_dollar_project(document, '{ "a" : { "$numberInt" : "1" }, "_id" : { "$numberInt" : "0" } }'::documentdb_core.bson, '{ "now" : NOW_SYS_VARIABLE }'::documentdb_core.bson, 'en-u-ks-level1'::text), documentdb_api_internal.bson_orderby(document, '{ "_id" : { "$numberInt" : "1" } }'::documentdb_core.bson, 'en-u-ks-level1'::text)
                     Filter: (collection.document OPERATOR(documentdb_api_catalog.@=) '{ "c" : "cat", "collation" : "en-u-ks-level1" }'::documentdb_core.bson)
(13 rows)

ROLLBACK;
BEGIN;
-- deleteOne
SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "c": { "$in": ["DOG", "Cat"] } },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

SELECT documentdb_api.delete('db',
  '{ "delete": "coll_index_2",
     "deletes": [
       { "q": { "_id": 1, "c": { "$in": ["DOG", "Cat"] } },
         "limit": 1,
         "collation": { "locale": "en", "strength": 1 }
       }
     ]
   }');
                                         delete                                         
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""0"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "c": { "$in": ["DOG", "Cat"] } },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
BEGIN;
-- deleteMany
SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "$or": [{ "a": { "$lte": "RABBIT" } }, { "c": { "$gte": "cat" } }] },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
                                       document                                       
---------------------------------------------------------------------
 { "_id" : { "$numberInt" : "1" }, "a" : "Cat" }
 { "_id" : { "$numberInt" : "2" }, "a" : "cat" }
 { "_id" : { "$numberInt" : "3" }, "a" : "Dog" }
 { "_id" : { "$numberInt" : "4" }, "a" : "dog" }
 { "_id" : { "$numberInt" : "6" }, "a" : [ "Cat", "cat", "dog" ] }
 { "_id" : { "$numberInt" : "9" }, "a" : "Dog", "b" : "Chien" }
 { "_id" : { "$numberInt" : "10" }, "a" : "cat", "b" : [ "Chien", "Chat" ] }
 { "_id" : { "$numberInt" : "11" }, "a" : "dog", "c" : "kraman" }
 { "_id" : { "$numberInt" : "12" }, "a" : "cat", "c" : { "d" : "Okra" } }
 { "_id" : { "$numberInt" : "13" }, "a" : "cat", "c" : [ "Okra", "Kraman", "okra" ] }
 { "_id" : { "$numberInt" : "14" }, "a" : "cat", "b" : { "c" : "chat" } }
(11 rows)

SELECT documentdb_api.delete('db',
  '{ "delete": "coll_index_2",
     "deletes": [
       { "q": { "a": { "$lte": "RABBIT" } },
         "limit": 0,
         "collation": { "locale": "en", "strength": 1 }
       },
       { "q": { "c": { "$gte": "cat" } },
         "limit": 0,
         "collation": { "locale": "en", "strength": 1 }
       }
     ]
   }');
                                         delete                                          
---------------------------------------------------------------------
 ("{ ""n"" : { ""$numberInt"" : ""11"" }, ""ok"" : { ""$numberDouble"" : ""1.0"" } }",t)
(1 row)

SELECT document FROM bson_aggregation_find('db',
  '{ "find": "coll_index_2",
     "filter": { "$or": [{ "a": { "$lte": "RABBIT" } }, { "c": { "$gte": "cat" } }] },
     "sort": { "_id": 1 },
     "collation": { "locale": "en", "strength": 1 }
   }');
 document 
---------------------------------------------------------------------
(0 rows)

ROLLBACK;
SELECT documentdb_api.unshard_collection('{ "unshardCollection": "db.coll_index_2" }');
 unshard_collection 
---------------------------------------------------------------------
 
(1 row)

CALL documentdb_api.drop_indexes('db', '{ "dropIndexes": "coll_index_2", "index": ["*"]}');
                          retval                          
---------------------------------------------------------------------
 { "ok" : true, "nIndexesWas" : { "$numberLong" : "1" } }
(1 row)

RESET documentdb_api.forceUseIndexIfAvailable;
RESET documentdb.enableCollationWithIndexes;
ALTER SYSTEM SET documentdb_core.enablecollation='off';
SELECT pg_reload_conf();
 pg_reload_conf 
---------------------------------------------------------------------
 t
(1 row)

