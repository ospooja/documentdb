SET citus.next_shard_id TO 11000;
SET documentdb.next_collection_id TO 110;
SET documentdb.next_collection_index_id TO 110;
SET search_path TO documentdb_core,documentdb_api,documentdb_api_catalog,documentdb_api_internal,public;
SELECT documentdb_api.create_collection('testdb', 'test_collection_node_1');
NOTICE:  creating collection
 create_collection 
---------------------------------------------------------------------
 t
(1 row)

SELECT documentdb_api.insert_one('testdb', 'test_collection_node_1', '{"_id": 1, "test": "value1"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('testdb', 'test_collection_node_1', '{"_id": 2, "test": "value2"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('testdb', 'test_collection_node_1', '{"_id": 3, "test": "value3"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('testdb', 'test_collection_node_1', '{"_id": 4, "test": "value4"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

SELECT documentdb_api.insert_one('testdb', 'test_collection_node_1', '{"_id": 5, "test": "value5"}');
                              insert_one                              
---------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- Try to place it on a node that doesn't exist
SELECT documentdb_distributed_test_helpers.place_collection_on_node('testdb', 'test_collection_node_1', 10);
ERROR:  Cound not find shard provided in metadata: shard_10
CONTEXT:  SQL statement "SELECT documentdb_api_distributed.move_collection(
			documentdb_core.bson_build_document('moveCollection'::text, format('%s.%s', p_database_name, p_collection_name), 'toShard'::text, format('shard_%s', p_node_number::text))
		)"
PL/pgSQL function documentdb_distributed_test_helpers.place_collection_on_node(text,text,integer) line 13 at PERFORM
-- Place it on node 1
SELECT documentdb_distributed_test_helpers.place_collection_on_node('testdb', 'test_collection_node_1', 1);
 place_collection_on_node 
---------------------------------------------------------------------
 t
(1 row)

SELECT object_id, document FROM documentdb_api.collection('testdb', 'test_collection_node_1') WHERE document @@ '{ "_id": { "$lte" : 5 }}' ORDER BY object_id;
            object_id            |                       document                        
---------------------------------------------------------------------
 { "" : { "$numberInt" : "1" } } | { "_id" : { "$numberInt" : "1" }, "test" : "value1" }
 { "" : { "$numberInt" : "2" } } | { "_id" : { "$numberInt" : "2" }, "test" : "value2" }
 { "" : { "$numberInt" : "3" } } | { "_id" : { "$numberInt" : "3" }, "test" : "value3" }
 { "" : { "$numberInt" : "4" } } | { "_id" : { "$numberInt" : "4" }, "test" : "value4" }
 { "" : { "$numberInt" : "5" } } | { "_id" : { "$numberInt" : "5" }, "test" : "value5" }
(5 rows)

EXPLAIN (VERBOSE ON, COSTS OFF, TIMING OFF) SELECT object_id, document FROM documentdb_api.collection('testdb', 'test_collection_node_1') WHERE document @@ '{ "_id": { "$lte" : 5 }}' ORDER BY object_id;
                                                                                                                                                                                                                                                         QUERY PLAN                                                                                                                                                                                                                                                         
---------------------------------------------------------------------
 Custom Scan (Citus Adaptive)
   Output: remote_scan.object_id, remote_scan.document
   Task Count: 1
   Tasks Shown: All
   ->  Task
         Query: SELECT object_id, document FROM documentdb_data.documents_111_11002 collection WHERE ((document OPERATOR(documentdb_api_catalog.#<=) '{ "_id" : { "$numberInt" : "5" } }'::documentdb_core.bsonquery) AND ((object_id OPERATOR(documentdb_core.<=) '{ "" : { "$numberInt" : "5" } }'::documentdb_core.bson) AND (object_id OPERATOR(documentdb_core.>=) '{ "" : { "$numberDouble" : "-Infinity" } }'::documentdb_core.bson)) AND (shard_key_value OPERATOR(pg_catalog.=) '111'::bigint)) ORDER BY object_id
         Node: host=localhost port=58081 dbname=postgres
         ->  Sort
               Output: object_id, document
               Sort Key: collection.object_id
               ->  Seq Scan on documentdb_data.documents_111_11002 collection
                     Output: object_id, document
                     Filter: ((collection.document OPERATOR(documentdb_api_catalog.@<=) '{ "_id" : { "$numberInt" : "5" } }'::documentdb_core.bson) AND (collection.object_id OPERATOR(documentdb_core.<=) '{ "" : { "$numberInt" : "5" } }'::documentdb_core.bson) AND (collection.object_id OPERATOR(documentdb_core.>=) '{ "" : { "$numberDouble" : "-Infinity" } }'::documentdb_core.bson))
(13 rows)

